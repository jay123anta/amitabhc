<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmitabhC Pro - Professional Bollywood IDE</title>
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   script-src 'self' 'unsafe-inline' cdnjs.cloudflare.com; 
                   style-src 'self' 'unsafe-inline' cdnjs.cloudflare.com; 
                   img-src 'self' data:;
                   connect-src 'self';
                   frame-ancestors 'none';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#ff9933">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎬</text></svg>">
    
    <!-- CodeMirror CDN with fallback -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" 
          onerror="this.onerror=null; this.href='css/vendor/codemirror.css';">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css"
          onerror="this.onerror=null; this.href='css/vendor/dracula.css';">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css"
          onerror="this.onerror=null; this.href='css/vendor/show-hint.css';">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'JetBrains Mono', monospace;
            background: #0d1117;
            color: #e6edf3;
            height: 100vh;
            overflow: hidden;
        }

        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #000;
            color: #fff;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 1000;
        }

        .skip-link:focus {
            top: 6px;
        }

        /* Main App Layout */
        .app {
            display: grid;
            grid-template-rows: 64px 1fr 32px;
            height: 100vh;
            background: #0d1117;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            padding: 0 24px;
            display: flex;
            align-items: center;
            gap: 24px;
            border-bottom: 3px solid #ff9933;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .logo {
            font-size: 1.8em;
            font-weight: 900;
            color: #ff9933;
            text-shadow: 0 2px 4px rgba(255,153,51,0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo::before {
            content: '🎬';
            font-size: 1.2em;
            animation: rotate 4s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .controls {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff9933, #e67e00);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255,153,51,0.3);
            min-height: 44px;
        }

        .btn-primary:hover,
        .btn-primary:focus {
            background: linear-gradient(135deg, #e67e00, #cc6600);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(255,153,51,0.4);
            outline: 3px solid #ff9933;
            outline-offset: 2px;
        }

        .btn-secondary {
            background: #374151;
            color: #e5e7eb;
            border: 1px solid #4b5563;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-secondary:hover,
        .btn-secondary:focus {
            background: #4b5563;
            border-color: #6b7280;
            outline: 2px solid #ff9933;
            outline-offset: 2px;
        }

        /* Main Content */
        .content {
            display: grid;
            grid-template-columns: 280px 1fr;
            overflow: hidden;
            background: #0d1117;
        }

        /* Sidebar */
        .sidebar {
            background: #161b22;
            border-right: 1px solid #30363d;
            display: grid;
            grid-template-rows: auto 1fr auto;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #30363d;
            background: #1c2128;
        }

        .sidebar-title {
            color: #ff9933;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .file-explorer {
            padding: 8px;
            overflow-y: auto;
        }

        .file-item {
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            transition: all 0.2s ease;
            color: #e6edf3;
            min-height: 44px;
            border: 2px solid transparent;
        }

        .file-item:hover {
            background: #21262d;
        }

        .file-item:focus {
            outline: none;
            border-color: #ff9933;
            background: #21262d;
        }

        .file-item.active {
            background: rgba(255,153,51,0.15);
            color: #ff9933;
            border-left: 3px solid #ff9933;
        }

        .ai-panel {
            padding: 16px;
            border-top: 1px solid #30363d;
            background: #1c2128;
        }

        .ai-assistant {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .ai-assistant:hover,
        .ai-assistant:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139,92,246,0.3);
            border-color: #8b5cf6;
            outline: none;
        }

        /* Workspace */
        .workspace {
            display: grid;
            grid-template-rows: 48px minmax(300px, 1fr) minmax(200px, 400px);
            overflow: hidden;
            background: #0d1117;
        }

        /* Tabs */
        .tabs {
            background: #161b22;
            display: flex;
            border-bottom: 1px solid #30363d;
            padding: 0 12px;
            align-items: flex-end;
        }

        .tab {
            padding: 12px 20px;
            background: #21262d;
            color: #7d8590;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            position: relative;
            top: 1px;
            min-height: 44px;
            border: 2px solid transparent;
        }

        .tab:focus {
            outline: none;
            border-color: #ff9933;
        }

        .tab.active {
            background: #0d1117;
            color: #ff9933;
            border-bottom: 2px solid #ff9933;
        }

        .tab-close {
            margin-left: 8px;
            padding: 2px 4px;
            border-radius: 3px;
            opacity: 0.6;
            cursor: pointer;
            border: none;
            background: none;
            color: inherit;
        }

        .tab-close:hover,
        .tab-close:focus {
            background: rgba(255,255,255,0.1);
            opacity: 1;
            outline: 1px solid #ff9933;
        }

        /* Editor */
        .editor-section {
            position: relative;
            overflow: hidden;
            background: #0d1117;
            min-height: 400px;
        }

        .CodeMirror {
            height: 100% !important;
            min-height: 400px !important;
            font-size: 16px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            line-height: 1.6;
            background: #0d1117 !important;
            color: #e6edf3 !important;
        }

        .CodeMirror-focused .CodeMirror-cursor {
            border-color: #ff9933 !important;
        }

        .CodeMirror-selected {
            background: rgba(255,153,51,0.2) !important;
        }

        .CodeMirror-gutters {
            background: #161b22 !important;
            border-right: 1px solid #30363d !important;
        }

        .CodeMirror-linenumber {
            color: #7d8590 !important;
        }

        .CodeMirror-activeline-background {
            background: rgba(255,153,51,0.1) !important;
        }

        /* Output Section */
        .output-section {
            background: #0d1117;
            border-top: 2px solid #ff9933;
            display: grid;
            grid-template-rows: 48px 1fr;
            overflow: hidden;
        }

        .output-header {
            background: #161b22;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #30363d;
        }

        .output-title {
            font-weight: 600;
            color: #ff9933;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .output-controls {
            display: flex;
            gap: 8px;
        }

        .output-body {
            padding: 16px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            background: #0d1117;
        }

        .output-line {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid transparent;
            animation: fadeIn 0.3s ease;
            word-wrap: break-word;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .output-line.info {
            color: #58a6ff;
            background: rgba(88,166,255,0.1);
            border-left-color: #58a6ff;
        }

        .output-line.print {
            color: #e6edf3;
            background: rgba(255,153,51,0.1);
            border-left-color: #ff9933;
        }

        .output-line.success {
            color: #56d364;
            background: rgba(86,211,100,0.1);
            border-left-color: #56d364;
        }

        .output-line.error {
            color: #f85149;
            background: rgba(248,81,73,0.1);
            border-left-color: #f85149;
        }

        .output-line.warning {
            color: #d29922;
            background: rgba(210,153,34,0.1);
            border-left-color: #d29922;
        }

        .output-line.kbc {
            color: #ff9933;
            background: linear-gradient(90deg, rgba(255,153,51,0.1), rgba(255,153,51,0.05));
            border-left-color: #ff9933;
            border-radius: 8px;
            font-weight: 500;
        }

        /* Status Bar */
        .status {
            background: #161b22;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            border-top: 1px solid #30363d;
            font-size: 12px;
            color: #7d8590;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-item.ready {
            color: #56d364;
        }

        .status-item.error {
            color: #f85149;
        }

        /* Resize Handle */
        .resize-handle {
            position: absolute;
            top: -3px;
            left: 0;
            right: 0;
            height: 6px;
            background: transparent;
            cursor: ns-resize;
            z-index: 100;
        }

        .resize-handle:hover {
            background: rgba(255,153,51,0.3);
        }

        /* AI Chat Dialog */
        .ai-chat {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            height: 600px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            display: none;
            grid-template-rows: 60px 1fr 60px;
            z-index: 1000;
        }

        .ai-chat.active {
            display: grid;
        }

        .ai-chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border-radius: 12px 12px 0 0;
            color: white;
        }

        .ai-chat-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-chat-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 18px;
            min-height: 32px;
            min-width: 32px;
        }

        .ai-chat-close:hover,
        .ai-chat-close:focus {
            background: rgba(255,255,255,0.2);
            outline: 2px solid white;
        }

        .ai-messages {
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ai-message {
            padding: 12px 16px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .ai-message.user {
            align-self: flex-end;
            background: #ff9933;
            color: white;
        }

        .ai-message.ai {
            align-self: flex-start;
            background: #21262d;
            color: #e6edf3;
        }

        .ai-input-area {
            padding: 16px;
            border-top: 1px solid #30363d;
            display: flex;
            gap: 8px;
        }

        .ai-input {
            flex: 1;
            background: #21262d;
            border: 1px solid #30363d;
            color: #e6edf3;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            min-height: 44px;
        }

        .ai-input:focus {
            outline: 2px solid #ff9933;
            border-color: #ff9933;
        }

        .ai-send {
            background: #ff9933;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            min-height: 44px;
            min-width: 60px;
        }

        .ai-send:hover,
        .ai-send:focus {
            background: #e67e00;
            outline: 2px solid #ff9933;
        }

        /* Screen reader only */
        .sr-only {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 240px 1fr;
            }
            
            .header {
                padding: 0 16px;
                gap: 16px;
            }
            
            .logo {
                font-size: 1.5em;
            }
            
            .controls {
                gap: 12px;
            }
        }

        @media (max-width: 768px) {
            .app {
                grid-template-rows: auto 1fr auto;
            }
            
            .header {
                padding: 12px;
                flex-wrap: wrap;
                gap: 12px;
            }
            
            .logo {
                font-size: 1.4em;
                order: 1;
                flex: 1;
            }
            
            .controls {
                order: 2;
                flex-wrap: wrap;
                gap: 8px;
                width: 100%;
            }
            
            .btn-primary, .btn-secondary {
                flex: 1;
                min-width: 120px;
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1000;
                background: #161b22;
            }
            
            .sidebar.mobile-open {
                display: grid;
            }
            
            .workspace {
                grid-template-rows: 48px minmax(200px, 1fr) minmax(150px, 300px);
            }
            
            .CodeMirror {
                min-height: 200px !important;
                font-size: 14px;
            }
            
            .ai-chat {
                width: 95vw;
                height: 85vh;
                max-width: none;
            }
            
            .output-section {
                min-height: 150px;
            }
            
            .status {
                padding: 0 12px;
                font-size: 11px;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .status-item {
                font-size: 11px;
            }
        }

        /* Mobile-specific utilities */
        .mobile-toggle {
            display: none;
        }
        
        @media (max-width: 768px) {
            .mobile-toggle {
                display: block;
                background: none;
                border: 1px solid #4b5563;
                color: #e5e7eb;
                padding: 8px;
                border-radius: 4px;
                cursor: pointer;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #30363d;
            border-top: 2px solid #ff9933;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #161b22;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast support */
        @media (prefers-contrast: high) {
            .btn-primary, .btn-secondary {
                border: 2px solid #fff;
            }
        }
    </style>
</head>
<body>
    <!-- Skip link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="app">
        <!-- Header -->
        <header class="header" role="banner" aria-label="AmitabhC Pro IDE Header">
            <div class="logo">
                AmitabhC Pro
                <span style="font-size: 0.7em; opacity: 0.8;">Professional IDE</span>
            </div>
            
            <nav class="controls" role="navigation" aria-label="Main IDE controls">
                <button class="mobile-toggle" 
                        onclick="toggleMobileSidebar()" 
                        aria-label="Toggle file explorer"
                        aria-expanded="false">
                    📁
                </button>
                
                <button class="btn-primary" 
                        onclick="runCode()" 
                        aria-label="Run AmitabhC code"
                        aria-describedby="run-help"
                        aria-keyshortcuts="F5"
                        id="runButton">
                    ▶️ Run
                </button>
                <div id="run-help" class="sr-only">Press F5 to run your AmitabhC program</div>
                
                <button class="btn-secondary" 
                        onclick="toggleAI()" 
                        aria-label="Toggle AI Assistant"
                        aria-expanded="false"
                        aria-controls="aiChat"
                        id="aiToggle">
                    🤖 AI
                </button>
                
                <button class="btn-secondary" 
                        onclick="exportCode()" 
                        aria-label="Export code to file">
                    📥 Export
                </button>
                
                <button class="btn-secondary" 
                        onclick="saveToCloud()" 
                        aria-label="Save to local storage">
                    ☁️ Save
                </button>
            </nav>
            
            <div style="margin-left: auto; display: flex; align-items: center; gap: 16px;">
                <div role="status" aria-live="polite">
                    <span class="loading" id="loadingSpinner" style="display: none;" aria-hidden="true"></span>
                    <span id="statusText">Ready</span>
                </div>
                <span style="font-size: 11px; color: #30363d;">v2.0</span>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="content" role="main">
            <!-- Sidebar -->
            <aside class="sidebar" role="complementary" aria-label="File Explorer and Tools">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">
                        📁 Project Explorer
                    </h2>
                </div>
                
                <nav class="file-explorer" role="navigation" aria-label="Project files">
                    <button class="file-item active" 
                            onclick="openFile('main.amitabhc')" 
                            aria-current="page"
                            data-file="main">
                        🎬 main.amitabhc
                    </button>
                    <button class="file-item" 
                            onclick="openFile('examples.amitabhc')" 
                            data-file="examples">
                        📚 examples.amitabhc
                    </button>
                    <button class="file-item" 
                            onclick="openFile('functions.amitabhc')" 
                            data-file="functions">
                        ⚡ functions.amitabhc
                    </button>
                    <button class="file-item" 
                            onclick="openFile('calculator.amitabhc')" 
                            data-file="calculator">
                        🧮 calculator.amitabhc
                    </button>
                    <button class="file-item" 
                            onclick="openFile('kbc_game.amitabhc')" 
                            data-file="kbc">
                        🎯 kbc_game.amitabhc
                    </button>
                    <button class="file-item" 
                            onclick="openFile('kbc_advanced.amitabhc')" 
                            data-file="kbc_advanced">
                        🏆 kbc_advanced.amitabhc
                    </button>
                    <button class="file-item" 
                            onclick="openFile('patterns.amitabhc')" 
                            data-file="patterns">
                        🌟 patterns.amitabhc
                    </button>
                </nav>
                
                <div class="ai-panel">
                    <button class="ai-assistant" 
                            onclick="toggleAI()"
                            aria-label="Open AI Assistant for coding help">
                        <div style="font-weight: 600; margin-bottom: 4px;">🤖 AI Assistant</div>
                        <div style="font-size: 11px; opacity: 0.9;">Get coding help instantly</div>
                    </button>
                </div>
            </aside>

            <!-- Workspace -->
            <section class="workspace" aria-label="Code Editor Workspace">
                <!-- Tabs -->
                <nav role="tablist" aria-label="Open files" class="tabs">
                    <button role="tab" 
                            class="tab active" 
                            aria-selected="true"
                            aria-controls="editor-panel"
                            id="currentTab">
                        🎬 <span id="tabName">main.amitabhc</span>
                        <button class="tab-close" 
                                onclick="closeTab()"
                                aria-label="Close current file"
                                tabindex="-1">×</button>
                    </button>
                </nav>

                <!-- Editor -->
                <div role="tabpanel" 
                     id="editor-panel"
                     aria-labelledby="currentTab"
                     class="editor-section">
                    <label for="codeEditor" class="sr-only">
                        AmitabhC code editor. Use Tab to indent, Shift+Tab to unindent. Press F5 to run code.
                    </label>
                    <textarea id="codeEditor" aria-describedby="editor-help">LIGHTS
CAMERA
    // 🎬 Welcome to AmitabhC Pro - Professional Bollywood IDE!
    DEVIYON_AUR_SAJJANO
    BOLO "Namaste! Welcome to AmitabhC Pro!"
    BOLO "Rishtey mein toh hum tumhare advanced compiler lagte hain!"
    
    // 🎭 Variable declarations with style
    VIJAY name = "Amitabh Bachchan"
    VIJAY age = 80
    DON films_count = 200
    
    BOLO "Superstar Details:"
    BOLO "Name: " + name
    BOLO "Age: " + age + " years"
    BOLO "Films: " + films_count + " movies"
    
    // 🎯 Conditional logic
    AGAR age > 75
        BOLO "Main hoon ek living legend!"
        BOLO "Experience ka koi shortcut nahi hota beta!"
    NAHI TOH
        BOLO "Abhi toh main jawaan hoon!"
    BAS
    
    // 🔄 Loop demonstration
    BOLO "Famous Dialogues:"
    BAAR BAAR 3
        BOLO "- Don ko pakadna mushkil hi nahi, namumkin hai!"
    KHATAM
    
    // ⚡ Function example
    NAAM greetAudience(message)
        BOLO "🎬 " + message
        WAPAS SHAKTI
    PURA
    
    greetAudience("Keh diya, bas keh diya!")
    
    // 📊 Array demonstration
    VIJAY iconic_movies[] = {"Sholay", "Deewar", "Don", "Agneepath", "Coolie"}
    BOLO "Iconic Movies: " + iconic_movies
    
    // 🎯 KBC Style Interactive
    BOLO "=== KBC Style Programming Quiz ==="
    COMPUTER_JI_LOCK_KIYA_JAYE
    BOLO "Successfully locked in the answer!"
    
    BOLO "✨ AmitabhC Pro Features Unlocked!"
    BOLO "- AI-Powered Code Assistance"
    BOLO "- Advanced Debugging Tools"
    BOLO "- Cloud Synchronization"
    BOLO "- Multi-format Export"
    BOLO "- Voice Coding Support"
    
ACTION</textarea>
                    <div id="editor-help" class="sr-only">
                        AmitabhC Pro editor with syntax highlighting and autocomplete. 
                        Use Ctrl+Space for suggestions, F5 to run code.
                    </div>
                </div>

                <!-- Output Section -->
                <section class="output-section" 
                         role="log" 
                         aria-label="Program Output">
                    <div class="resize-handle" 
                         id="resizeHandle"
                         aria-label="Resize output panel"
                         role="separator"></div>
                    
                    <div class="output-header">
                        <h3 class="output-title">
                            📺 Output Console
                        </h3>
                        <div class="output-controls" role="group" aria-label="Output controls">
                            <button class="btn-secondary" 
                                    onclick="clearOutput()" 
                                    aria-label="Clear console output">
                                🗑️
                            </button>
                            <button class="btn-secondary" 
                                    onclick="toggleFullscreen()" 
                                    aria-label="Toggle fullscreen output">
                                ⛶
                            </button>
                        </div>
                    </div>
                    
                    <div class="output-body" 
                         id="outputBody"
                         role="log"
                         aria-live="polite"
                         aria-label="Program execution output">
                        <div class="output-line info">
                            ✨ AmitabhC Pro IDE is ready!
                        </div>
                        <div class="output-line info">
                            🎬 "Jahan code shuru hota hai, wahin se programming ki line shuru hoti hai!"
                        </div>
                    </div>
                </section>
            </section>
        </main>

        <!-- Status Bar -->
        <footer class="status" role="contentinfo" aria-label="IDE Status">
            <div class="status-item ready">
                <span aria-hidden="true">●</span>
                <span id="mainStatus">Ready</span>
            </div>
            <div class="status-item">
                <span id="cursorPosition">Line 1, Col 1</span>
            </div>
            <div class="status-item">
                <span id="fileEncoding">UTF-8</span>
            </div>
            <div class="status-item">
                <span>AmitabhC</span>
            </div>
            <div style="margin-left: auto;">
                <span>Pro IDE v2.0</span>
            </div>
        </footer>
    </div>

    <!-- AI Chat Dialog -->
    <dialog class="ai-chat" 
            id="aiChat"
            aria-labelledby="ai-chat-title"
            aria-describedby="ai-chat-desc">
        <div class="ai-chat-header">
            <h2 id="ai-chat-title" class="ai-chat-title">
                🤖 AmitabhC AI Assistant
            </h2>
            <button class="ai-chat-close" 
                    onclick="toggleAI()"
                    aria-label="Close AI Assistant">×</button>
        </div>
        
        <div id="ai-chat-desc" class="sr-only">
            AI assistant to help with AmitabhC programming questions and debugging
        </div>
        
        <div class="ai-messages" 
             id="aiMessages"
             role="log"
             aria-live="polite"
             aria-label="AI conversation history">
            <!-- Messages will be added here -->
        </div>
        
        <form onsubmit="sendAIMessage(); return false;" class="ai-input-area">
            <label for="aiInput" class="sr-only">Ask AI Assistant about AmitabhC programming</label>
            <input type="text" 
                   class="ai-input" 
                   id="aiInput"
                   placeholder="Ask me anything about AmitabhC..."
                   aria-describedby="ai-input-help"
                   maxlength="1000">
            <button type="submit" 
                    class="ai-send" 
                    aria-label="Send message to AI assistant">Send</button>
            <div id="ai-input-help" class="sr-only">
                Type your question about AmitabhC programming and press Enter or click Send
            </div>
        </form>
    </dialog>

    <!-- Load secure interpreter -->
    <script src="interpreter.js"></script>
    
    <!-- Load CodeMirror with fallback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"
            onerror="loadFallbackScript('js/vendor/codemirror.min.js')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"
            onerror="loadFallbackScript('js/vendor/javascript.min.js')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"
            onerror="loadFallbackScript('js/vendor/show-hint.min.js')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"
            onerror="loadFallbackScript('js/vendor/matchbrackets.min.js')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"
            onerror="loadFallbackScript('js/vendor/closebrackets.min.js')"></script>

    <script>
        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            addOutput('⚠️ An unexpected error occurred. Please check the console.', 'error');
        });

        // Promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            event.preventDefault();
        });

        // Fallback script loader
        function loadFallbackScript(src) {
            console.log('Loading fallback script:', src);
            const script = document.createElement('script');
            script.src = src;
            script.async = false;
            document.head.appendChild(script);
        }

        // Global Variables
        let editor;
        let interpreter;
        let currentFile = 'main.amitabhc';
        let isResizing = false;
        let startY, startHeight;
        
        // Enhanced file contents with more examples
        const fileContents = {
            'main.amitabhc': document.getElementById('codeEditor').value,
            'examples.amitabhc': `LIGHTS
CAMERA
    BOLO "🎬 AmitabhC Examples Showcase!"
    BOLO "================================="
    
    // 📊 Mathematics and Variables
    VIJAY num1 = 100
    VIJAY num2 = 42
    VIJAY result = num1 + num2
    BOLO "Mathematical Operation:"
    BOLO num1 + " + " + num2 + " = " + result
    
    // 🎯 Conditional Logic
    VIJAY temperature = 35
    BOLO "Weather Check:"
    AGAR temperature > 30
        BOLO "🌡️ It's hot! Temperature: " + temperature + "°C"
        BOLO "Garmi mein bhi hum cool rahe hain!"
    NAHI TOH AGAR temperature < 20
        BOLO "🌨️ It's cold! Bundle up!"
    NAHI TOH
        BOLO "🌤️ Perfect weather!"
    BAS
    
    // 🔄 Loop Demonstrations
    BOLO "Counting with BAAR BAAR:"
    BAAR BAAR 5
        BOLO "⭐ Superstar moment!"
    KHATAM
    
    BOLO "While loop with JAB TAK:"
    VIJAY countdown = 5
    JAB TAK countdown > 0
        BOLO "🚀 Launch in " + countdown + " seconds"
        VIJAY countdown = countdown - 1
    RAHEGA
    BOLO "🎬 Action!"
    
    // 📚 Array Operations
    VIJAY movies[] = {"Sholay", "Deewar", "Don", "Agneepath"}
    BOLO "Iconic Movies Array:"
    BOLO "Total movies: " + movies
    BOLO "First movie: " + movies[0]
    BOLO "Last movie: " + movies[3]
    
    BOLO "✨ Examples completed successfully!"
ACTION`,
            
            'functions.amitabhc': `LIGHTS
CAMERA
    BOLO "⚡ AmitabhC Functions Masterclass!"
    BOLO "====================================="
    
    // 🎭 Simple Function
    NAAM greetBollywood()
        BOLO "🎬 Welcome to Bollywood Programming!"
        BOLO "Lights, Camera, Code!"
    PURA
    
    // 🧮 Function with Parameters
    NAAM calculate(operation, a, b)
        AGAR operation == "add"
            VIJAY result = a + b
            BOLO a + " + " + b + " = " + result
        NAHI TOH AGAR operation == "multiply"
            VIJAY result = a * b
            BOLO a + " × " + b + " = " + result
        NAHI TOH
            BOLO "Unknown operation: " + operation
        BAS
    PURA
    
    // 🎯 Function with Return Value
    NAAM getSuperheroName(realName)
        AGAR realName == "Amitabh"
            WAPAS "Shahenshah"
        NAHI TOH AGAR realName == "Vijay"
            WAPAS "Don"
        NAHI TOH
            WAPAS "Hero"
        BAS
    PURA
    
    // 🔢 Recursive Function
    NAAM factorial(n)
        AGAR n <= 1
            WAPAS 1
        NAHI TOH
            WAPAS n * factorial(n - 1)
        BAS
    PURA
    
    // 🎪 Function Calls
    BOLO "=== Function Demonstrations ==="
    greetBollywood()
    
    BOLO "=== Calculator Functions ==="
    calculate("add", 25, 17)
    calculate("multiply", 8, 9)
    
    BOLO "=== Superhero Name Generator ==="
    VIJAY hero1 = getSuperheroName("Amitabh")
    VIJAY hero2 = getSuperheroName("Vijay")
    BOLO "Amitabh is known as: " + hero1
    BOLO "Vijay is known as: " + hero2
    
    BOLO "=== Factorial Calculator ==="
    VIJAY fact5 = factorial(5)
    VIJAY fact7 = factorial(7)
    BOLO "Factorial of 5: " + fact5
    BOLO "Factorial of 7: " + fact7
    
    BOLO "🎉 Function masterclass completed!"
ACTION`,
            
            'calculator.amitabhc': `LIGHTS
CAMERA
    BOLO "🧮 AmitabhC Advanced Calculator"
    BOLO "================================"
    
    // 📊 Calculator Functions
    NAAM add(x, y)
        WAPAS x + y
    PURA
    
    NAAM subtract(x, y)
        WAPAS x - y
    PURA
    
    NAAM multiply(x, y)
        WAPAS x * y
    PURA
    
    NAAM divide(x, y)
        AGAR y == 0
            BOLO "❌ Error: Division by zero!"
            WAPAS 0
        NAHI TOH
            WAPAS x / y
        BAS
    PURA
    
    NAAM power(base, exponent)
        VIJAY result = 1
        BAAR BAAR exponent
            VIJAY result = result * base
        KHATAM
        WAPAS result
    PURA
    
    // 🎯 Calculator Demo
    VIJAY num1 = 144
    VIJAY num2 = 12
    
    BOLO "Calculator Input:"
    BOLO "Number 1: " + num1
    BOLO "Number 2: " + num2
    BOLO "------------------------"
    
    VIJAY sum = add(num1, num2)
    VIJAY difference = subtract(num1, num2)
    VIJAY product = multiply(num1, num2)
    VIJAY quotient = divide(num1, num2)
    VIJAY power_result = power(num2, 2)
    
    BOLO "➕ Addition: " + num1 + " + " + num2 + " = " + sum
    BOLO "➖ Subtraction: " + num1 + " - " + num2 + " = " + difference
    BOLO "✖️ Multiplication: " + num1 + " × " + num2 + " = " + product
    BOLO "➗ Division: " + num1 + " ÷ " + num2 + " = " + quotient
    BOLO "🔢 Power: " + num2 + "² = " + power_result
    
    // 📈 Advanced Calculations
    BOLO "=== Advanced Calculations ==="
    VIJAY percentage = (num2 / num1) * 100
    BOLO "📊 " + num2 + " is " + percentage + "% of " + num1
    
    VIJAY average = (num1 + num2) / 2
    BOLO "📊 Average: " + average
    
    BOLO "✅ Calculator operations completed!"
    BOLO "Hisaab kitaab ho gaya!"
ACTION`,
            
            'kbc_game.amitabhc': `LIGHTS
CAMERA
    // 🎯 Kaun Banega Crorepati - AmitabhC Edition
    BOLO "🏆 KAUN BANEGA CROREPATI - CODING EDITION 🏆"
    BOLO "=============================================="
    DEVIYON_AUR_SAJJANO
    BOLO "Main hoon aapka host, Amitabh Bachchan!"
    BOLO "Aaj hum khelenge programming ka sabse bada quiz!"
    
    // 🎮 Game State
    VIJAY total_winnings = 0
    VIJAY current_question = 1
    VIJAY lifeline_5050 = SHAKTI
    VIJAY lifeline_audience = SHAKTI
    VIJAY lifeline_phone = SHAKTI
    
    // 💰 Prize Money Ladder
    VIJAY prize_ladder[] = {1000, 5000, 10000, 50000, 100000, 500000, 1000000}
    
    BOLO "🎯 Question " + current_question + " for Rs. " + prize_ladder[0] + ":"
    BOLO "AmitabhC mein variable declare karne ke liye kya use hote hai?"
    BOLO "A) VAR    B) LET    C) VIJAY    D) VARIABLE"
    
    // 🆘 Lifeline Options
    BOLO "🆘 Available Lifelines:"
    AGAR lifeline_5050 == SHAKTI
        BOLO "1️⃣ Fifty-Fifty"
    BAS
    AGAR lifeline_audience == SHAKTI
        BOLO "2️⃣ Audience Poll"
    BAS
    AGAR lifeline_phone == SHAKTI
        BOLO "3️⃣ Phone a Friend"
    BAS
    
    // 🎯 Simulate lifeline usage
    BOLO "🎪 Using Audience Poll lifeline..."
    AUDIENCE_POLL
    BOLO "📊 83% audience voted for option C!"
    VIJAY lifeline_audience = KAALIA
    
    // 💡 Expert advice
    BOLO "🎓 Let's also get expert advice..."
    EXPERT_ADVICE
    
    // 🔒 Lock the answer
    BOLO "🎯 Final Answer: C) VIJAY"
    CONFIDENT_TO_LOCK_KIYA_JAYE
    
    // ✅ Correct Answer
    BOLO "🎉 BILKUL SAHI JAWAB!"
    COMPUTER_JI_LOCK_KIYA_JAYE
    VIJAY total_winnings = prize_ladder[0]
    BOLO "🏆 Congratulations! You've won Rs. " + total_winnings + "!"
    
    // 🏁 Game Summary
    BOLO "🏆 GAME SUMMARY"
    BOLO "==============="
    BOLO "Questions Answered: " + current_question
    BOLO "Total Winnings: Rs. " + total_winnings
    
    AGAR total_winnings >= 1000
        BOLO "🌟 EXCELLENT PERFORMANCE!"
        BOLO "Aap ek true AmitabhC programmer hain!"
    BAS
    
    BOLO "🎬 Thank you for playing KBC - Coding Edition!"
    BOLO "Milte hain phir, nayi programming adventures ke saath!"
    BOLO "Dhanyawad!"
ACTION`,
            
            'kbc_advanced.amitabhc': `LIGHTS
CAMERA
    // 🏆 KBC Advanced - The Ultimate Programming Challenge
    BOLO "🎪 KAUN BANEGA CROREPATI - ADVANCED EDITION 🎪"
    BOLO "==============================================="
    DEVIYON_AUR_SAJJANO
    BOLO "Welcome to the most challenging programming quiz!"
    BOLO "Aaj ka sawaal hai - Can you become a Crorepati coder?"
    
    // 🎮 Advanced Game State
    VIJAY player_score = 0
    VIJAY question_level = 1
    VIJAY difficulty_multiplier = 1
    VIJAY bonus_points = 0
    
    // 🏆 Advanced Prize Structure
    VIJAY mega_prizes[] = {1000, 5000, 10000, 50000, 100000, 500000, 1000000, 5000000}
    
    // 🆘 Enhanced Lifelines
    VIJAY lifeline_5050 = SHAKTI
    VIJAY lifeline_audience = SHAKTI
    VIJAY lifeline_phone = SHAKTI
    VIJAY lifeline_expert = SHAKTI
    
    // 🎯 Question Bank Function
    NAAM askAdvancedQuestion(level)
        AGAR level == 1
            BOLO "🔥 Advanced Question " + level + " for Rs. " + mega_prizes[level-1] + ":"
            BOLO "What does 'JAB TAK' create in AmitabhC?"
            BOLO "A) For Loop    B) While Loop    C) If Condition    D) Function"
            WAPAS "B"
        NAHI TOH AGAR level == 2
            BOLO "🔥 Advanced Question " + level + " for Rs. " + mega_prizes[level-1] + ":"
            BOLO "Which command is used for function return?"
            BOLO "A) RETURN    B) WAPAS    C) BACK    D) END"
            WAPAS "B"
        NAHI TOH AGAR level == 3
            BOLO "🔥 Expert Question " + level + " for Rs. " + mega_prizes[level-1] + ":"
            BOLO "What represents 'true' in AmitabhC?"
            BOLO "A) TRUE    B) SHAKTI    C) YES    D) ON"
            WAPAS "B"
        NAHI TOH
            BOLO "🏆 JACKPOT Question for Rs. " + mega_prizes[level-1] + ":"
            BOLO "What does 'DEVIYON_AUR_SAJJANO' do?"
            BOLO "A) Print    B) Input    C) Greeting    D) Exit"
            WAPAS "C"
        BAS
    PURA
    
    // 🎮 Main Game Loop
    BOLO "🎪 Let the advanced challenge begin!"
    
    // 🎯 Question 1
    VIJAY correct_answer = askAdvancedQuestion(1)
    AUDIENCE_POLL
    
    BOLO "🤔 Thinking time... What's your final answer?"
    CONFIDENT_TO_LOCK_KIYA_JAYE
    
    BOLO "✅ Correct! SHABASH!"
    COMPUTER_JI_LOCK_KIYA_JAYE
    VIJAY player_score = mega_prizes[0]
    VIJAY bonus_points = bonus_points + 100
    
    // 🎯 Question 2
    VIJAY question_level = 2
    VIJAY correct_answer = askAdvancedQuestion(2)
    PHONE_A_FRIEND "AmitabhC Master Programmer"
    
    BOLO "🎯 This is getting serious! Lock your answer?"
    CONFIDENT_TO_LOCK_KIYA_JAYE
    
    BOLO "🎉 FANTASTIC! You're on fire!"
    COMPUTER_JI_LOCK_KIYA_JAYE
    VIJAY player_score = mega_prizes[1]
    VIJAY bonus_points = bonus_points + 250
    
    // 🏁 Grand Finale
    BOLO "🏆 GRAND FINALE RESULTS 🏆"
    BOLO "=========================="
    BOLO "Final Score: Rs. " + player_score
    BOLO "Bonus Points: " + bonus_points
    VIJAY total_achievement = player_score + bonus_points
    BOLO "Total Achievement: Rs. " + total_achievement
    
    BOLO "🎪 Performance Analysis:"
    AGAR player_score >= 5000
        BOLO "🌟 OUTSTANDING! AmitabhC EXPERT level achieved!"
        BOLO "You deserve the title: 'Shahenshah of Coding'!"
    NAHI TOH AGAR player_score >= 1000
        BOLO "🎯 EXCELLENT! Advanced programmer status!"
        BOLO "Title earned: 'Don of AmitabhC'!"
    NAHI TOH
        BOLO "👍 GOOD EFFORT! Keep practicing!"
        BOLO "Title: 'Rising Star Programmer'!"
    BAS
    
    // 🎬 Epic Conclusion
    BOLO "🎬 Yeh kahani khatam nahi hui..."
    BOLO "AmitabhC programming adventure continues!"
    BOLO "Keep coding, keep learning, keep growing!"
    BOLO "'Jab tak programming hai, tab tak AmitabhC hai!'"
    BOLO "Thank you for playing KBC Advanced Edition!"
    
    // 🎊 Victory Dance
    BAAR BAAR 3
        BOLO "🎉 CELEBRATION TIME! 🎉"
    KHATAM
    
ACTION`,
            
            'patterns.amitabhc': `LIGHTS
CAMERA
    BOLO "🌟 AmitabhC Pattern Programming Showcase!"
    BOLO "========================================"
    
    // 🔷 Pattern 1: Simple Square
    BOLO "📐 Pattern 1: Square Matrix"
    BOLO "- - - - - - - - - -"
    BAAR BAAR 5
        BAAR BAAR 5
            BOLO "⭐ "
        KHATAM
        BOLO ""
    KHATAM
    
    // 🔺 Pattern 2: Right Triangle
    BOLO "📐 Pattern 2: Right Triangle"
    BOLO "- - - - - - - - - -"
    VIJAY row = 1
    JAB TAK row <= 6
        VIJAY col = 1
        JAB TAK col <= row
            BOLO "🔸 "
            VIJAY col = col + 1
        RAHEGA
        BOLO ""
        VIJAY row = row + 1
    RAHEGA
    
    // 🔢 Pattern 3: Number Pyramid
    BOLO "📐 Pattern 3: Number Pyramid"
    BOLO "- - - - - - - - - -"
    VIJAY level = 1
    JAB TAK level <= 5
        VIJAY num = 1
        JAB TAK num <= level
            BOLO num + " "
            VIJAY num = num + 1
        RAHEGA
        BOLO ""
        VIJAY level = level + 1
    RAHEGA
    
    // 🎭 Pattern 4: Bollywood Style
    BOLO "🎬 Pattern 4: Bollywood Special"
    BOLO "- - - - - - - - - -"
    VIJAY bollywood_row = 1
    JAB TAK bollywood_row <= 4
        AGAR bollywood_row == 1
            BOLO "    🎬 AMITABH 🎬"
        NAHI TOH AGAR bollywood_row == 2
            BOLO "  🌟 BACHCHAN 🌟"
        NAHI TOH AGAR bollywood_row == 3
            BOLO "🎭 SUPERSTAR 🎭"
        NAHI TOH
            BOLO "🏆 LEGEND 🏆"
        BAS
        BOLO ""
        VIJAY bollywood_row = bollywood_row + 1
    RAHEGA
    
    // 🎯 Interactive Pattern Generator
    BOLO "🎯 Interactive Pattern Generator"
    BOLO "================================"
    
    NAAM generateCustomPattern(size, symbol)
        BOLO "Custom Pattern (Size: " + size + ", Symbol: " + symbol + "):"
        VIJAY pattern_row = 1
        JAB TAK pattern_row <= size
            VIJAY pattern_col = 1
            JAB TAK pattern_col <= pattern_row
                BOLO symbol + " "
                VIJAY pattern_col = pattern_col + 1
            RAHEGA
            BOLO ""
            VIJAY pattern_row = pattern_row + 1
        RAHEGA
    PURA
    
    // Test custom pattern generator
    generateCustomPattern(6, "🔥")
    
    BOLO "✨ Pattern showcase completed!"
    BOLO "🎬 Patterns mein bhi Bollywood ka jadoo!"
    BOLO "Keep creating beautiful patterns with AmitabhC!"
ACTION`
        };

        // Initialize CodeMirror Editor
        window.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            try {
                // Initialize secure interpreter
                if (typeof SecureAmitabhCInterpreter === 'undefined') {
                    throw new Error('Secure interpreter not loaded');
                }
                
                interpreter = new SecureAmitabhCInterpreter();
                interpreter.setOutputCallback(addOutput);
                interpreter.setInputCallback(securePrompt);

                // Wait for CodeMirror to load
                await waitForCodeMirror();
                
                // Initialize CodeMirror editor
                const textarea = document.getElementById('codeEditor');
                
                editor = CodeMirror.fromTextArea(textarea, {
                    mode: 'javascript',
                    theme: 'dracula',
                    lineNumbers: true,
                    lineWrapping: true,
                    matchBrackets: true,
                    autoCloseBrackets: true,
                    indentUnit: 4,
                    tabSize: 4,
                    styleActiveLine: true,
                    viewportMargin: Infinity,
                    extraKeys: {
                        "F5": function() { runCode(); },
                        "Ctrl-Space": "autocomplete",
                        "Ctrl-S": function() { saveToCloud(); },
                        "Ctrl-/": "toggleComment",
                        "Ctrl-Enter": function() { runCode(); }
                    }
                });
                
                // Set editor size
                editor.setSize("100%", "400px");
                
                // Update cursor position
                editor.on('cursorActivity', function() {
                    try {
                        const cursor = editor.getCursor();
                        document.getElementById('cursorPosition').textContent = `Line ${cursor.line + 1}, Col ${cursor.ch + 1}`;
                    } catch (error) {
                        console.error('Cursor position update error:', error);
                    }
                });
                
                // Auto-refresh editor
                setTimeout(() => {
                    editor.refresh();
                    forceEditorResize();
                }, 100);
                
                // Setup resize functionality
                setupResize();
                
                // Initialize AI
                initializeAI();
                
                // Load default file
                openFile('main.amitabhc');
                
                addOutput('✨ AmitabhC Pro IDE loaded successfully!', 'success');
                addOutput('🎬 "Lights, Camera, Code!" - Welcome to professional Bollywood programming!', 'info');
                
            } catch (error) {
                console.error('App initialization error:', error);
                addOutput('❌ IDE initialization failed. Please refresh the page.', 'error');
            }
        }

        // Wait for CodeMirror to load
        function waitForCodeMirror() {
            return new Promise((resolve) => {
                if (typeof CodeMirror !== 'undefined') {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (typeof CodeMirror !== 'undefined') {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                    
                    // Timeout after 10 seconds
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        console.error('CodeMirror failed to load');
                        resolve(); // Continue anyway
                    }, 10000);
                }
            });
        }

        // Enhanced secure prompt function
        async function securePrompt(message) {
            return new Promise((resolve) => {
                try {
                    // Sanitize the message
                    const sanitizedMessage = String(message || 'Enter value:')
                        .replace(/<[^>]*>/g, '')
                        .slice(0, 200);
                    
                    const input = prompt(sanitizedMessage);
                    
                    if (input === null) {
                        resolve(null);
                        return;
                    }
                    
                    // Sanitize and limit input
                    const sanitizedInput = String(input)
                        .slice(0, 1000)
                        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
                    
                    resolve(sanitizedInput);
                } catch (error) {
                    console.error('Input error:', error);
                    resolve(null);
                }
            });
        }

        // Force editor resize
        function forceEditorResize() {
            if (editor) {
                const editorSection = document.querySelector('.editor-section');
                const height = editorSection.offsetHeight;
                editor.setSize("100%", Math.max(400, height - 10) + "px");
                editor.refresh();
            }
        }

        // File Management
        function openFile(filename) {
            try {
                // Save current file
                if (editor) {
                    fileContents[currentFile] = editor.getValue();
                }
                
                // Update UI
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('active');
                    item.removeAttribute('aria-current');
                    if (item.getAttribute('data-file') === filename.replace('.amitabhc', '')) {
                        item.classList.add('active');
                        item.setAttribute('aria-current', 'page');
                    }
                });
                
                // Load new file
                currentFile = filename;
                if (editor) {
                    const content = fileContents[filename] || '// New file\nLIGHTS\nCAMERA\n    BOLO "Hello AmitabhC!"\nACTION';
                    editor.setValue(content);
                    document.getElementById('tabName').textContent = filename;
                }
                
                updateStatus('File opened: ' + filename);
                announceToScreenReader(`Opened file: ${filename}`);
                
            } catch (error) {
                console.error('Open file error:', error);
                addOutput('❌ Failed to open file', 'error');
            }
        }

        function closeTab() {
            // In a real implementation, handle multiple tabs
            updateStatus('Tab management - Pro feature');
            announceToScreenReader('Tab close feature coming soon');
        }

        // Enhanced run code function
        async function runCode() {
            try {
                if (!editor || !interpreter) {
                    throw new Error('Editor or interpreter not available');
                }
                
                const code = editor.getValue().trim();
                const runButton = document.getElementById('runButton');
                
                if (!code) {
                    addOutput('📝 Please write some AmitabhC code first!', 'warning');
                    editor.focus();
                    return;
                }
                
                // Disable run button and show loading
                runButton.disabled = true;
                runButton.innerHTML = '⏳ Running...';
                document.getElementById('loadingSpinner').style.display = 'inline-block';
                document.getElementById('statusText').textContent = 'Running...';
                
                clearOutput();
                addOutput('🎬 Lights... Camera... Action!', 'info');
                addOutput('🚀 Starting AmitabhC Pro execution...', 'info');
                
                // Run with interpreter
                const result = await interpreter.run(code);
                
                if (result.success) {
                    addOutput('✅ Program executed successfully!', 'success');
                    addOutput(`⏱️ Execution time: ${result.executionTime}ms`, 'info');
                    addOutput(`📊 Memory usage: ${result.memoryUsage.variables} variables, ${result.memoryUsage.arrays} arrays, ${result.memoryUsage.functions} functions`, 'info');
                    addOutput('🎬 "Keh diya, bas keh diya!" - Program completed!', 'success');
                    updateStatus('Ready');
                } else {
                    addOutput(`❌ Runtime Error: ${result.error}`, 'error');
                    addOutput('🔧 Check your AmitabhC syntax and try again!', 'warning');
                    updateStatus('Error', 'error');
                }
                
                announceToScreenReader(result.success ? 'Program executed successfully' : 'Program execution failed');
                
            } catch (error) {
                console.error('Execution error:', error);
                addOutput(`❌ Execution failed: ${error.message}`, 'error');
                addOutput('🛡️ Program stopped for security reasons', 'warning');
                updateStatus('Error', 'error');
            } finally {
                // Re-enable run button
                const runButton = document.getElementById('runButton');
                if (runButton) {
                    runButton.disabled = false;
                    runButton.innerHTML = '▶️ Run';
                }
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('statusText').textContent = 'Ready';
            }
        }

        // Enhanced output function
        function addOutput(text, type = 'print') {
            try {
                const outputBody = document.getElementById('outputBody');
                if (!outputBody) return;
                
                // Sanitize text
                const sanitizedText = String(text || '')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .slice(0, 10000);
                
                const line = document.createElement('div');
                line.className = `output-line ${type}`;
                
                // Add icons and styling based on type
                let icon = '';
                switch (type) {
                    case 'print': icon = '💬'; break;
                    case 'info': icon = 'ℹ️'; break;
                    case 'success': icon = '✅'; break;
                    case 'error': icon = '❌'; break;
                    case 'warning': icon = '⚠️'; break;
                    case 'kbc': icon = '🎯'; break;
                    default: icon = '📝';
                }
                
                line.innerHTML = `<span style="margin-right: 8px;" aria-hidden="true">${icon}</span>${sanitizedText}`;
                outputBody.appendChild(line);
                outputBody.scrollTop = outputBody.scrollHeight;
                
            } catch (error) {
                console.error('Output error:', error);
            }
        }

        function clearOutput() {
            try {
                const outputBody = document.getElementById('outputBody');
                if (outputBody) {
                    outputBody.innerHTML = '';
                    addOutput('Console cleared - Ready for new output! 🧹', 'info');
                }
            } catch (error) {
                console.error('Clear output error:', error);
            }
        }

        // UI Controls
        function toggleFullscreen() {
            const workspace = document.querySelector('.workspace');
            const currentGrid = workspace.style.gridTemplateRows;
            
            if (currentGrid.includes('0px')) {
                // Restore normal view
                workspace.style.gridTemplateRows = '48px minmax(300px, 1fr) minmax(200px, 400px)';
                announceToScreenReader('Restored normal view');
            } else {
                // Maximize output
                workspace.style.gridTemplateRows = '48px 0px 1fr';
                announceToScreenReader('Maximized output panel');
            }
            
            if (editor) {
                setTimeout(() => editor.refresh(), 100);
            }
        }

        function updateStatus(message, type = 'ready') {
            try {
                const statusElement = document.getElementById('mainStatus');
                const statusItem = statusElement.parentElement;
                
                statusElement.textContent = message;
                statusItem.className = `status-item ${type}`;
                updateStatus.lastStatus = message;
            } catch (error) {
                console.error('Status update error:', error);
            }
        }

        // AI Assistant
        function toggleAI() {
            try {
                const aiChat = document.getElementById('aiChat');
                const aiToggle = document.getElementById('aiToggle');
                const isOpen = aiChat.classList.contains('active');
                
                if (isOpen) {
                    aiChat.classList.remove('active');
                    aiToggle.setAttribute('aria-expanded', 'false');
                    announceToScreenReader('AI Assistant closed');
                } else {
                    aiChat.classList.add('active');
                    aiToggle.setAttribute('aria-expanded', 'true');
                    document.getElementById('aiInput').focus();
                    announceToScreenReader('AI Assistant opened');
                }
            } catch (error) {
                console.error('Toggle AI error:', error);
            }
        }

        function sendAIMessage() {
            try {
                const input = document.getElementById('aiInput');
                const messages = document.getElementById('aiMessages');
                const userMessage = input.value.trim();
                
                if (!userMessage) return;
                
                // Sanitize input
                const sanitizedMessage = userMessage
                    .replace(/<[^>]*>/g, '')
                    .slice(0, 1000);
                
                // Add user message
                const userDiv = document.createElement('div');
                userDiv.className = 'ai-message user';
                userDiv.textContent = sanitizedMessage;
                messages.appendChild(userDiv);
                
                // Clear input
                input.value = '';
                
                // Generate AI response
                setTimeout(() => {
                    const aiDiv = document.createElement('div');
                    aiDiv.className = 'ai-message ai';
                    aiDiv.innerHTML = generateAIResponse(sanitizedMessage);
                    messages.appendChild(aiDiv);
                    messages.scrollTop = messages.scrollHeight;
                }, 1000);
                
                messages.scrollTop = messages.scrollHeight;
                
            } catch (error) {
                console.error('Send AI message error:', error);
            }
        }

        function handleAIEnter(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAIMessage();
            }
        }

        function generateAIResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Enhanced AI responses with more comprehensive help
            if (lowerMessage.includes('error') || lowerMessage.includes('bug') || lowerMessage.includes('not working')) {
                return `🐛 <strong>Debugging AmitabhC Code:</strong><br><br>
                <strong>Common Issues & Solutions:</strong><br>
                • Program structure: Start with <code>LIGHTS</code>, include <code>CAMERA</code>, end with <code>ACTION</code><br>
                • Block endings: <code>AGAR...BAS</code>, <code>BAAR BAAR...KHATAM</code>, <code>JAB TAK...RAHEGA</code><br>
                • Function syntax: <code>NAAM functionName()...PURA</code><br>
                • Variable naming: Use <code>VIJAY varName = value</code><br>
                • Array syntax: <code>VIJAY arrayName[] = {item1, item2}</code><br><br>
                <strong>Security Features:</strong><br>
                • Input validation and sanitization<br>
                • Memory usage monitoring<br>
                • Execution time limits<br>
                • Safe expression evaluation<br><br>
                <strong>Pro Tip:</strong> Use the browser console (F12) for detailed error information!`;
            }
            
            if (lowerMessage.includes('syntax') || lowerMessage.includes('how') || lowerMessage.includes('command')) {
                return `📚 <strong>AmitabhC Pro Syntax Guide:</strong><br><br>
                <strong>Program Structure:</strong><br>
                <code>LIGHTS</code> - Program start<br>
                <code>CAMERA</code> - Main code section<br>
                <code>ACTION</code> - Program end<br><br>
                <strong>Variables & Data:</strong><br>
                <code>VIJAY name = "Amitabh"</code> - String variable<br>
                <code>VIJAY age = 80</code> - Number variable<br>
                <code>DON pi = 3.14</code> - Constant<br>
                <code>VIJAY movies[] = {"Sholay", "Don"}</code> - Array<br><br>
                <strong>I/O Operations:</strong><br>
                <code>BOLO "Hello World"</code> - Output text<br>
                <code>SUNO userName</code> - Get user input<br><br>
                <strong>Control Flow:</strong><br>
                <code>AGAR condition...BAS</code> - If statement<br>
                <code>BAAR BAAR 5...KHATAM</code> - For loop<br>
                <code>JAB TAK condition...RAHEGA</code> - While loop<br><br>
                <strong>Functions:</strong><br>
                <code>NAAM greet(name)...PURA</code> - Function definition<br>
                <code>WAPAS value</code> - Return statement`;
            }
            
            if (lowerMessage.includes('kbc') || lowerMessage.includes('quiz') || lowerMessage.includes('lifeline')) {
                return `🎯 <strong>KBC Interactive Programming:</strong><br><br>
                <strong>Host Commands:</strong><br>
                <code>DEVIYON_AUR_SAJJANO</code> - Welcome greeting<br>
                <code>COMPUTER_JI_LOCK_KIYA_JAYE</code> - Lock answer<br>
                <code>CONFIDENT_TO_LOCK_KIYA_JAYE</code> - Confirm choice<br><br>
                <strong>Lifeline System:</strong><br>
                <code>LIFELINE_FIFTY_FIFTY</code> - Eliminate wrong options<br>
                <code>AUDIENCE_POLL</code> - Get crowd opinion<br>
                <code>PHONE_A_FRIEND "Expert"</code> - Call for help<br>
                <code>EXPERT_ADVICE</code> - Professional analysis<br>
                <code>QUIT_GAME</code> - Exit with winnings<br><br>
                <strong>Game Features:</strong><br>
                • Prize ladder arrays<br>
                • Score tracking variables<br>
                • Lifeline management<br>
                • Question randomization<br><br>
                💡 <strong>Pro Tip:</strong> Check out kbc_game.amitabhc and kbc_advanced.amitabhc for complete implementations!`;
            }
            
            if (lowerMessage.includes('example') || lowerMessage.includes('sample') || lowerMessage.includes('learn')) {
                return `💡 <strong>AmitabhC Pro Learning Resources:</strong><br><br>
                <strong>Available Example Files:</strong><br>
                • <code>examples.amitabhc</code> - Basic syntax and concepts<br>
                • <code>functions.amitabhc</code> - Advanced function examples<br>
                • <code>calculator.amitabhc</code> - Mathematical operations<br>
                • <code>kbc_game.amitabhc</code> - Interactive quiz game<br>
                • <code>kbc_advanced.amitabhc</code> - Complex game logic<br>
                • <code>patterns.amitabhc</code> - Visual programming patterns<br><br>
                <strong>Learning Path:</strong><br>
                1. Start with <code>examples.amitabhc</code> for basics<br>
                2. Explore <code>functions.amitabhc</code> for advanced concepts<br>
                3. Try <code>calculator.amitabhc</code> for practical applications<br>
                4. Build games with KBC examples<br>
                5. Create art with <code>patterns.amitabhc</code><br><br>
                <strong>IDE Features:</strong><br>
                • Syntax highlighting with CodeMirror<br>
                • Real-time error detection<br>
                • Auto-save functionality<br>
                • Export to multiple formats<br>
                • Performance monitoring<br><br>
                🎬 <strong>Remember:</strong> "Practice makes perfect - Abhyas se hi AmitabhC mastery aati hai!"`;
            }
            
            if (lowerMessage.includes('performance') || lowerMessage.includes('optimize') || lowerMessage.includes('slow')) {
                return `⚡ <strong>AmitabhC Pro Performance Guide:</strong><br><br>
                <strong>Built-in Optimizations:</strong><br>
                • Secure expression evaluation (no eval/Function)<br>
                • Memory usage monitoring<br>
                • Execution time tracking<br>
                • Loop iteration limits<br>
                • Input/output rate limiting<br><br>
                <strong>Best Practices:</strong><br>
                • Use appropriate data types<br>
                • Avoid deeply nested loops<br>
                • Limit recursive function depth<br>
                • Use arrays efficiently<br>
                • Handle errors gracefully<br><br>
                <strong>Security Features:</strong><br>
                • XSS protection<br>
                • Input sanitization<br>
                • Content Security Policy<br>
                • Safe variable naming<br><br>
                <strong>Monitoring Tools:</strong><br>
                • Real-time execution metrics<br>
                • Memory usage display<br>
                • Performance warnings<br>
                • Error reporting<br><br>
                💫 <strong>Pro Feature:</strong> The IDE automatically optimizes your code for better performance!`;
            }
            
            // Default comprehensive response
            return `🤖 <strong>AmitabhC Pro AI Assistant</strong><br><br>
            Welcome to the most advanced Bollywood programming environment! I can help with:<br><br>
            <strong>🎬 Code Development:</strong><br>
            • Syntax help and debugging<br>
            • Function and class design<br>
            • Algorithm optimization<br>
            • Performance tuning<br><br>
            <strong>🎯 Interactive Features:</strong><br>
            • KBC quiz programming<br>
            • Game development<br>
            • Pattern creation<br>
            • User interface design<br><br>
            <strong>🛡️ Security & Best Practices:</strong><br>
            • Secure coding techniques<br>
            • Input validation<br>
            • Error handling<br>
            • Code review<br><br>
            <strong>💡 Quick Commands to Try:</strong><br>
            • "How do I create a function?"<br>
            • "Show me KBC examples"<br>
            • "My code has an error"<br>
            • "Optimize my program"<br>
            • "Explain patterns"<br><br>
            🎬 <strong>Ready to code like a Bollywood superstar?</strong> "Rishta wahi soch nahi!"`;
        }

        function initializeAI() {
            try {
                const messages = document.getElementById('aiMessages');
                const welcomeMsg = document.createElement('div');
                welcomeMsg.className = 'ai-message ai';
                welcomeMsg.innerHTML = `🎬 <strong>Welcome to AmitabhC Pro!</strong><br><br>
                I'm your advanced AI coding assistant, ready to help with:<br>
                • Secure AmitabhC programming<br>
                • Advanced debugging and optimization<br>
                • KBC-style interactive development<br>
                • Professional code architecture<br>
                • Performance monitoring and tuning<br><br>
                Ask me anything! "Jahan AI meets Bollywood, wahin se magic shuru hota hai!" ✨`;
                messages.appendChild(welcomeMsg);
            } catch (error) {
                console.error('AI initialization error:', error);
            }
        }

        // Advanced Features
        function exportCode() {
            try {
                if (!editor) return;
                
                const code = editor.getValue();
                const filename = currentFile || 'amitabhc_program.amitabhc';
                
                if (!code.trim()) {
                    addOutput('📝 No code to export!', 'warning');
                    return;
                }
                
                // Create safe filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const safeFilename = `${filename.replace('.amitabhc', '')}-${timestamp}.amitabhc`;
                
                const blob = new Blob([code], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = safeFilename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                addOutput(`📥 Code exported as ${safeFilename}`, 'success');
                updateStatus('Code exported successfully');
                announceToScreenReader('Code exported successfully');
                
            } catch (error) {
                console.error('Export error:', error);
                addOutput('❌ Export failed', 'error');
            }
        }

        function saveToCloud() {
            try {
                if (!editor) return;
                
                const code = editor.getValue();
                const timestamp = new Date().toISOString();
                
                // Save to localStorage (simulating cloud save)
                localStorage.setItem('amitabhc_pro_autosave', code);
                localStorage.setItem('amitabhc_pro_autosave_time', timestamp);
                localStorage.setItem('amitabhc_pro_current_file', currentFile);
                
                addOutput('☁️ Code saved to local storage', 'success');
                updateStatus('Auto-saved');
                announceToScreenReader('Code saved successfully');
                
                // Simulate cloud backup
                setTimeout(() => {
                    addOutput('💾 Backup synchronized successfully', 'info');
                }, 1000);
                
            } catch (error) {
                console.error('Save error:', error);
                addOutput('❌ Save failed', 'error');
            }
        }

        // Enhanced accessibility helper
        function announceToScreenReader(message) {
            try {
                const announcement = document.createElement('div');
                announcement.setAttribute('aria-live', 'polite');
                announcement.setAttribute('aria-atomic', 'true');
                announcement.className = 'sr-only';
                announcement.textContent = message;
                document.body.appendChild(announcement);
                
                setTimeout(() => {
                    if (document.body.contains(announcement)) {
                        document.body.removeChild(announcement);
                    }
                }, 1000);
            } catch (error) {
                console.error('Announcement error:', error);
            }
        }

        // Mobile sidebar toggle
        function toggleMobileSidebar() {
            try {
                const sidebar = document.querySelector('.sidebar');
                const toggle = document.querySelector('.mobile-toggle');
                const isOpen = sidebar.classList.contains('mobile-open');
                
                if (isOpen) {
                    sidebar.classList.remove('mobile-open');
                    toggle.setAttribute('aria-expanded', 'false');
                    announceToScreenReader('File explorer closed');
                } else {
                    sidebar.classList.add('mobile-open');
                    toggle.setAttribute('aria-expanded', 'true');
                    announceToScreenReader('File explorer opened');
                }
            } catch (error) {
                console.error('Mobile sidebar toggle error:', error);
            }
        }

        // Resize functionality
        function setupResize() {
            try {
                const resizeHandle = document.getElementById('resizeHandle');
                const workspace = document.querySelector('.workspace');
                const outputSection = document.querySelector('.output-section');
                
                let isResizing = false;
                let startY = 0;
                let startHeight = 0;
                
                resizeHandle.addEventListener('mousedown', function(e) {
                    isResizing = true;
                    startY = e.clientY;
                    startHeight = outputSection.offsetHeight;
                    document.body.style.cursor = 'ns-resize';
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (!isResizing) return;
                    
                    const deltaY = startY - e.clientY;
                    const newHeight = Math.min(Math.max(150, startHeight + deltaY), 700);
                    
                    // Update grid template
                    const tabHeight = 48;
                    const totalHeight = workspace.offsetHeight;
                    const editorHeight = totalHeight - tabHeight - newHeight;
                    
                    workspace.style.gridTemplateRows = `${tabHeight}px ${editorHeight}px ${newHeight}px`;
                    
                    if (editor) {
                        editor.refresh();
                    }
                });
                
                document.addEventListener('mouseup', function() {
                    if (isResizing) {
                        isResizing = false;
                        document.body.style.cursor = '';
                    }
                });
                
            } catch (error) {
                console.error('Resize setup error:', error);
            }
        }

        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            try {
                // F5 - Run code
                if (e.key === 'F5') {
                    e.preventDefault();
                    runCode();
                }
                
                // Ctrl+S - Save to cloud
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveToCloud();
                }
                
                // Ctrl+E - Export code
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    exportCode();
                }
                
                // Ctrl+` - Toggle AI
                if (e.ctrlKey && e.key === '`') {
                    e.preventDefault();
                    toggleAI();
                }
                
                // Escape - Close modals
                if (e.key === 'Escape') {
                    const aiChat = document.getElementById('aiChat');
                    if (aiChat.classList.contains('active')) {
                        toggleAI();
                    }
                    
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar.classList.contains('mobile-open')) {
                        toggleMobileSidebar();
                    }
                }
                
                // Arrow key navigation for file explorer
                if (e.target.classList.contains('file-item')) {
                    const items = Array.from(document.querySelectorAll('.file-item'));
                    const current = items.indexOf(e.target);
                    
                    if (e.key === 'ArrowDown' && current < items.length - 1) {
                        e.preventDefault();
                        items[current + 1].focus();
                    } else if (e.key === 'ArrowUp' && current > 0) {
                        e.preventDefault();
                        items[current - 1].focus();
                    } else if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        e.target.click();
                    }
                }
                
            } catch (error) {
                console.error('Keyboard shortcut error:', error);
            }
        });

        // Enhanced mobile detection and handling
        function isMobile() {
            return window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function optimizeForMobile() {
            try {
                if (isMobile()) {
                    // Adjust editor for mobile
                    if (editor) {
                        editor.setOption('lineWrapping', true);
                        editor.setOption('styleActiveLine', false);
                        editor.setOption('fontSize', '14px');
                    }
                    
                    // Hide sidebar by default on mobile
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('mobile-open');
                    }
                    
                    // Optimize workspace grid for mobile
                    const workspace = document.querySelector('.workspace');
                    if (workspace) {
                        workspace.style.gridTemplateRows = '40px minmax(200px, 1fr) minmax(150px, 300px)';
                    }
                    
                    // Adjust AI chat for mobile
                    const aiChat = document.getElementById('aiChat');
                    if (aiChat) {
                        aiChat.style.width = '95vw';
                        aiChat.style.height = '85vh';
                    }
                }
            } catch (error) {
                console.error('Mobile optimization error:', error);
            }
        }

        // Handle orientation changes
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                optimizeForMobile();
                if (editor) {
                    editor.refresh();
                }
            }, 100);
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            optimizeForMobile();
            forceEditorResize();
        });

        // Auto-save functionality
        let autoSaveTimer;
        function setupAutoSave() {
            if (editor) {
                editor.on('change', function() {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(() => {
                        try {
                            const code = editor.getValue();
                            if (code.trim()) {
                                localStorage.setItem('amitabhc_pro_autosave', code);
                                localStorage.setItem('amitabhc_pro_autosave_time', new Date().toISOString());
                                localStorage.setItem('amitabhc_pro_current_file', currentFile);
                                
                                // Update status briefly
                                const originalStatus = document.getElementById('mainStatus').textContent;
                                updateStatus('Auto-saved');
                                setTimeout(() => {
                                    updateStatus(originalStatus);
                                }, 2000);
                            }
                        } catch (error) {
                            console.error('Auto-save error:', error);
                        }
                    }, 3000); // Auto-save after 3 seconds of inactivity
                });
            }
        }

        // Load saved code on startup
        window.addEventListener('load', function() {
            try {
                const savedCode = localStorage.getItem('amitabhc_pro_autosave');
                const savedTime = localStorage.getItem('amitabhc_pro_autosave_time');
                const savedFile = localStorage.getItem('amitabhc_pro_current_file');
                
                if (savedCode && savedTime) {
                    const timeDiff = Date.now() - new Date(savedTime).getTime();
                    // Only restore if saved within last 24 hours
                    if (timeDiff < 86400000) {
                        const shouldRestore = confirm('🔄 Found auto-saved code from earlier session. Would you like to restore it?');
                        if (shouldRestore && editor) {
                            editor.setValue(savedCode);
                            if (savedFile) {
                                currentFile = savedFile;
                                document.getElementById('tabName').textContent = savedFile;
                            }
                            addOutput('🔄 Auto-saved code restored!', 'success');
                            announceToScreenReader('Auto-saved code restored');
                        }
                    }
                }
                
                // Setup auto-save after restoration check
                setupAutoSave();
                
            } catch (error) {
                console.error('Auto-restore error:', error);
            }
        });

        // Performance monitoring
        if ('PerformanceObserver' in window) {
            try {
                const perfObserver = new PerformanceObserver(function(list) {
                    list.getEntries().forEach(function(entry) {
                        // Log performance metrics for debugging
                        if (entry.duration > 100) { // Only log slow operations
                            console.log('Performance:', entry.entryType, entry.name, `${entry.duration.toFixed(2)}ms`);
                        }
                    });
                });
                
                perfObserver.observe({ entryTypes: ['navigation', 'paint', 'measure'] });
            } catch (error) {
                console.log('Performance monitoring failed:', error);
            }
        }

        // Enhanced error handling for CodeMirror
        window.addEventListener('load', function() {
            if (typeof CodeMirror === 'undefined') {
                addOutput('⚠️ Advanced editor features unavailable. Basic editing still works.', 'warning');
                
                // Fallback: enhance textarea
                const textarea = document.getElementById('codeEditor');
                if (textarea) {
                    textarea.style.fontFamily = 'Consolas, Monaco, monospace';
                    textarea.style.fontSize = '14px';
                    textarea.style.lineHeight = '1.5';
                    textarea.addEventListener('keydown', function(e) {
                        if (e.key === 'Tab') {
                            e.preventDefault();
                            const start = this.selectionStart;
                            const end = this.selectionEnd;
                            this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                            this.selectionStart = this.selectionEnd = start + 4;
                        }
                    });
                }
            }
        });

        // Accessibility improvements
        document.addEventListener('DOMContentLoaded', function() {
            // Add keyboard navigation help
            const helpText = document.createElement('div');
            helpText.className = 'sr-only';
            helpText.id = 'keyboard-help';
            helpText.innerHTML = `
                <h2>Keyboard Shortcuts</h2>
                <ul>
                    <li>F5 or Ctrl+Enter: Run code</li>
                    <li>Ctrl+S: Save to storage</li>
                    <li>Ctrl+E: Export code</li>
                    <li>Ctrl+\`: Toggle AI assistant</li>
                    <li>Escape: Close dialogs</li>
                    <li>Arrow keys: Navigate file list</li>
                    <li>Tab: Navigate interface</li>
                </ul>
            `;
            document.body.appendChild(helpText);
            
            // Add focus management
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    document.body.classList.add('using-keyboard');
                }
            });
            
            document.addEventListener('mousedown', function() {
                document.body.classList.remove('using-keyboard');
            });
        });

        // Initialize touch improvements for mobile
        if ('ontouchstart' in window) {
            document.addEventListener('DOMContentLoaded', function() {
                // Add touch-friendly improvements
                const style = document.createElement('style');
                style.textContent = `
                    .file-item, .tab, .btn-primary, .btn-secondary {
                        min-height: 44px !important;
                        min-width: 44px !important;
                    }
                    
                    .resize-handle {
                        height: 20px !important;
                        background: rgba(255,153,51,0.3) !important;
                    }
                    
                    @media (hover: none) {
                        .file-item:hover, .tab:hover, button:hover {
                            transform: none !important;
                        }
                    }
                `;
                document.head.appendChild(style);
            });
        }

        // Service Worker registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('SW registered successfully');
                        addOutput('🔄 Offline support enabled', 'info');
                    })
                    .catch(function(error) {
                        console.log('SW registration failed:', error);
                    });
            });
        }

        // Network status monitoring
        window.addEventListener('online', function() {
            addOutput('🌐 Connection restored', 'success');
            updateStatus('Online');
        });

        window.addEventListener('offline', function() {
            addOutput('📶 Working offline', 'warning');
            updateStatus('Offline', 'warning');
        });

        // Memory usage monitoring
        function checkMemoryUsage() {
            if (performance.memory) {
                const used = Math.round(performance.memory.usedJSHeapSize / 1048576);
                const total = Math.round(performance.memory.totalJSHeapSize / 1048576);
                
                if (used > 100) { // More than 100MB
                    console.warn('High memory usage:', used, 'MB');
                    addOutput(`⚠️ High memory usage: ${used}MB`, 'warning');
                }
            }
        }

        // Check memory usage every 30 seconds
        setInterval(checkMemoryUsage, 30000);

        // Enhanced error boundary
        class ErrorBoundary {
            constructor() {
                this.hasError = false;
            }
            
            componentDidCatch(error, errorInfo) {
                this.hasError = true;
                console.error('Component error:', error, errorInfo);
                addOutput('❌ IDE component error. Please refresh the page.', 'error');
            }
        }

        // Global promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            addOutput('⚠️ Background operation failed', 'warning');
            event.preventDefault();
        });

        // Enhanced logging for production debugging
        const originalConsoleError = console.error;
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            
            // In production, you might want to send errors to a logging service
            if (args[0] && typeof args[0] === 'string' && args[0].includes('AmitabhC')) {
                // This is an AmitabhC-related error
                try {
                    const errorData = {
                        message: args[0],
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        currentFile: currentFile,
                        url: window.location.href
                    };
                    
                    // Store error locally for debugging
                    const errors = JSON.parse(localStorage.getItem('amitabhc_errors') || '[]');
                    errors.push(errorData);
                    
                    // Keep only last 10 errors
                    if (errors.length > 10) {
                        errors.splice(0, errors.length - 10);
                    }
                    
                    localStorage.setItem('amitabhc_errors', JSON.stringify(errors));
                } catch (e) {
                    // Ignore errors in error handling
                }
            }
        };

        // Analytics placeholder (for production)
        function trackEvent(eventName, properties = {}) {
            // In production, integrate with analytics service
            console.log('Event:', eventName, properties);
        }

        // Track important user actions
        function trackUserAction(action) {
            trackEvent('user_action', {
                action: action,
                file: currentFile,
                timestamp: Date.now()
            });
        }

        // Add tracking to key functions
        const originalRunCode = runCode;
        runCode = function() {
            trackUserAction('run_code');
            return originalRunCode.apply(this, arguments);
        };

        const originalOpenFile = openFile;
        openFile = function(filename) {
            trackUserAction('open_file');
            return originalOpenFile.apply(this, arguments);
        };

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Final initialization checks
            console.log('AmitabhC Pro IDE initializing...');
            
            // Check browser compatibility
            const isCompatible = (
                typeof Promise !== 'undefined' &&
                typeof localStorage !== 'undefined' &&
                typeof fetch !== 'undefined'
            );
            
            if (!isCompatible) {
                addOutput('⚠️ Your browser may not support all features. Please use a modern browser.', 'warning');
            }
            
            // Initialize performance tracking
            if (performance.mark) {
                performance.mark('amitabhc-ide-loaded');
            }
            
            console.log('AmitabhC Pro IDE ready! 🎬');
        });
    </script>
</body>
</html>