<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmitabhC Pro - Professional Bollywood IDE</title>
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   script-src 'self' 'unsafe-inline' cdnjs.cloudflare.com; 
                   style-src 'self' 'unsafe-inline' cdnjs.cloudflare.com; 
                   img-src 'self' data:;
                   connect-src 'self';
                   frame-ancestors 'none';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- SEO and PWA Meta -->
    <meta name="description" content="AmitabhC Pro IDE - Professional Bollywood programming environment with AI assistant, advanced debugging, and enterprise features.">
    <meta name="keywords" content="AmitabhC Pro, IDE, Bollywood programming, AI assistant, professional development">
    <meta name="author" content="AmitabhC Team">
    <meta name="theme-color" content="#ff9933">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    
    <!-- CodeMirror CDN with fallback -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" 
          onerror="this.onerror=null; this.href='css/vendor/codemirror.css';">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css"
          onerror="this.onerror=null; this.href='css/vendor/dracula.css';">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css"
          onerror="this.onerror=null; this.href='css/vendor/show-hint.css';">
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Critical CSS for Pro IDE -->
    <style>
        /* Critical Pro IDE styles */
        .app {
            display: grid;
            grid-template-rows: 64px 1fr 32px;
            height: 100vh;
            background: #0d1117;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            padding: 0 24px;
            display: flex;
            align-items: center;
            gap: 24px;
            border-bottom: 3px solid #ff9933;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 100;
        }

        .content {
            display: grid;
            grid-template-columns: 280px 1fr;
            overflow: hidden;
            background: #0d1117;
        }

        .sidebar {
            background: #161b22;
            border-right: 1px solid #30363d;
            display: grid;
            grid-template-rows: auto 1fr auto;
            overflow: hidden;
        }

        .workspace {
            display: grid;
            grid-template-rows: 48px minmax(300px, 1fr) minmax(200px, 400px);
            overflow: hidden;
            background: #0d1117;
        }

        .editor-section {
            position: relative;
            overflow: hidden;
            background: #0d1117;
            min-height: 400px;
        }

        .output-section {
            background: #0d1117;
            border-top: 2px solid #ff9933;
            display: grid;
            grid-template-rows: 48px 1fr;
            overflow: hidden;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
                position: fixed;
                top: 64px;
                left: 0;
                width: 100%;
                height: calc(100vh - 96px);
                z-index: 1000;
            }
            
            .sidebar.mobile-open {
                display: grid;
            }
            
            .workspace {
                grid-template-rows: 48px minmax(200px, 1fr) minmax(150px, 300px);
            }
        }

        /* Loading screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0d1117 0%, #1f2937 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            font-size: 4em;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        .loading-text {
            color: #ff9933;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #30363d;
            border-top: 4px solid #ff9933;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-logo">üé¨</div>
        <div class="loading-text">AmitabhC Pro IDE</div>
        <div class="loading-text" style="font-size: 1em; opacity: 0.8;">Loading Professional Bollywood Environment...</div>
        <div class="loading-spinner"></div>
    </div>

    <!-- Skip link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="app">
        <!-- Header -->
        <header class="header" role="banner" aria-label="AmitabhC Pro IDE Header">
            <div class="logo">
                <span style="font-size: 1.2em;">üé¨</span>
                AmitabhC Pro
                <span style="font-size: 0.7em; opacity: 0.8; margin-left: 8px;">Professional IDE</span>
            </div>
            
            <nav class="controls" role="navigation" aria-label="Main IDE controls">
                <button class="mobile-toggle" 
                        onclick="toggleMobileSidebar()" 
                        aria-label="Toggle file explorer"
                        aria-expanded="false"
                        style="display: none;">
                    üìÅ
                </button>
                
                <button class="btn-primary" 
                        onclick="runCode()" 
                        aria-label="Run AmitabhC code"
                        aria-describedby="run-help"
                        aria-keyshortcuts="F5"
                        id="runButton">
                    <span aria-hidden="true">‚ñ∂Ô∏è</span> Run
                </button>
                <div id="run-help" class="sr-only">Press F5 to run your AmitabhC program</div>
                
                <button class="btn-secondary" 
                        onclick="toggleAI()" 
                        aria-label="Toggle AI Assistant"
                        aria-expanded="false"
                        aria-controls="aiChat"
                        id="aiToggle">
                    <span aria-hidden="true">ü§ñ</span> AI
                </button>
                
                <button class="btn-secondary" 
                        onclick="exportCode()" 
                        aria-label="Export code to file"
                        class="tooltip"
                        data-tooltip="Export to multiple formats">
                    <span aria-hidden="true">üì•</span> Export
                </button>
                
                <button class="btn-secondary" 
                        onclick="saveToCloud()" 
                        aria-label="Save to local storage"
                        class="tooltip"
                        data-tooltip="Auto-save to local storage">
                    <span aria-hidden="true">‚òÅÔ∏è</span> Save
                </button>
                
                <button class="btn-secondary" 
                        onclick="openSettings()" 
                        aria-label="Open IDE settings"
                        class="tooltip"
                        data-tooltip="IDE preferences and settings">
                    <span aria-hidden="true">‚öôÔ∏è</span> Settings
                </button>
            </nav>
            
            <div style="margin-left: auto; display: flex; align-items: center; gap: 16px;">
                <div role="status" aria-live="polite" class="status-display">
                    <span class="loading" id="loadingSpinner" style="display: none;" aria-hidden="true"></span>
                    <span id="statusText">Ready</span>
                </div>
                <div class="version-info">
                    <span style="font-size: 11px; color: #30363d;">v2.0.3</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="content" role="main">
            <!-- Sidebar -->
            <aside class="sidebar" role="complementary" aria-label="File Explorer and Tools">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">
                        <span aria-hidden="true">üìÅ</span> Project Explorer
                    </h2>
                </div>
                
                <nav class="file-explorer" role="navigation" aria-label="Project files">
                    <button class="file-item active" 
                            onclick="openFile('main.amitabhc')" 
                            aria-current="page"
                            data-file="main">
                        <span aria-hidden="true">üé¨</span> main.amitabhc
                    </button>
                    <button class="file-item" 
                            onclick="openFile('examples.amitabhc')" 
                            data-file="examples">
                        <span aria-hidden="true">üìö</span> examples.amitabhc
                    </button>
                    <button class="file-item" 
                            onclick="openFile('functions.amitabhc')" 
                            data-file="functions">
                        <span aria-hidden="true">‚ö°</span> functions.amitabhc
                    </button>
                    <button class="file-item" 
                            onclick="openFile('calculator.amitabhc')" 
                            data-file="calculator">
                        <span aria-hidden="true">üßÆ</span> calculator.amitabhc
                    </button>
                    <button class="file-item" 
                            onclick="openFile('kbc_game.amitabhc')" 
                            data-file="kbc">
                        <span aria-hidden="true">üéØ</span> kbc_game.amitabhc
                    </button>
                </nav>
                
                <div class="ai-panel">
                    <button class="ai-assistant" 
                            onclick="toggleAI()"
                            aria-label="Open AI Assistant for coding help">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 1.5em;">ü§ñ</span>
                            <div>
                                <div style="font-weight: 600;">AI Assistant</div>
                                <div style="font-size: 11px; opacity: 0.9;">Powered by AmitabhC AI</div>
                            </div>
                        </div>
                        <div style="font-size: 11px; opacity: 0.8;">Get instant coding help, debugging support, and learn AmitabhC best practices!</div>
                    </button>
                </div>
            </aside>

            <!-- Workspace -->
            <section class="workspace" aria-label="Code Editor Workspace">
                <!-- Tabs -->
                <nav role="tablist" aria-label="Open files" class="tabs">
                    <button role="tab" 
                            class="tab active" 
                            aria-selected="true"
                            aria-controls="editor-panel"
                            id="currentTab">
                        <span aria-hidden="true">üé¨</span> 
                        <span id="tabName">main.amitabhc</span>
                        <button class="tab-close" 
                                onclick="closeTab()"
                                aria-label="Close current file"
                                tabindex="-1">√ó</button>
                    </button>
                </nav>

                <!-- Editor -->
                <div role="tabpanel" 
                     id="editor-panel"
                     aria-labelledby="currentTab"
                     class="editor-section">
                    <label for="codeEditor" class="sr-only">
                        AmitabhC Pro code editor with syntax highlighting and autocomplete. Use Tab to indent, Shift+Tab to unindent. Press F5 to run code.
                    </label>
                    <textarea id="codeEditor" aria-describedby="editor-help">LIGHTS
CAMERA
    // üé¨ Welcome to AmitabhC Pro - Professional Bollywood IDE!
    DEVIYON_AUR_SAJJANO
    BOLO "Namaste! Welcome to AmitabhC Pro!"
    BOLO "Rishtey mein toh hum tumhare advanced compiler lagte hain!"
    
    // üé≠ Enhanced variable declarations with style
    VIJAY name = "Amitabh Bachchan"
    VIJAY age = 80
    DON films_count = 200
    VIJAY experience_years = 55
    
    BOLO "üåü Superstar Profile:"
    BOLO "Name: " + name
    BOLO "Age: " + age + " years young"
    BOLO "Films: " + films_count + " iconic movies"
    BOLO "Experience: " + experience_years + " years in industry"
    
    // üéØ Advanced conditional logic with nested conditions
    AGAR age > 75
        BOLO "üèÜ Main hoon ek living legend!"
        BOLO "Experience ka koi shortcut nahi hota beta!"
        
        AGAR films_count > 150
            BOLO "üëë Century of cinema completed!"
            COMPUTER_JI_LOCK_KIYA_JAYE
        BAS
    NAHI TOH AGAR age > 50
        BOLO "üåü Prime time of career!"
    NAHI TOH
        BOLO "üöÄ Rising star phase!"
    BAS
    
    // üîÑ Enhanced loop demonstration with progress tracking
    BOLO "üé¨ Famous Dialogues Compilation:"
    VIJAY dialogue_count = 0
    BAAR BAAR 5
        VIJAY dialogue_count = dialogue_count + 1
        BOLO dialogue_count + ". Don ko pakadna mushkil hi nahi, namumkin hai!"
    KHATAM
    
    // ‚ö° Advanced function with error handling
    NAAM calculateCareerSpan(start_year, current_year)
        AGAR start_year > current_year
            BOLO "‚ùå Error: Start year cannot be greater than current year"
            WAPAS 0
        NAHI TOH
            VIJAY span = current_year - start_year
            BOLO "üìä Career Analysis:"
            BOLO "Started: " + start_year
            BOLO "Current: " + current_year
            BOLO "Span: " + span + " years"
            WAPAS span
        BAS
    PURA
    
    VIJAY career_span = calculateCareerSpan(1969, 2024)
    AGAR career_span > 50
        BOLO "üèÜ Golden Jubilee of Excellence!"
    BAS
    
    // üìä Array demonstration with data processing
    VIJAY hit_movies[] = {"Sholay", "Deewar", "Don", "Agneepath", "Piku"}
    BOLO "üé≠ Hit Movies Collection: " + hit_movies
    BOLO "Total hits: " + hit_movies
    
    // üéØ KBC Style Interactive Programming
    BOLO "Professional AmitabhC Programming Quiz"
    COMPUTER_JI_LOCK_KIYA_JAYE
    BOLO "üé™ Answer locked successfully!"
    
    BOLO "‚ú® AmitabhC Pro Features Showcase:"
    BOLO "- üõ°Ô∏è Enhanced Security with no eval()"
    BOLO "- ü§ñ AI-Powered Code Assistance"
    BOLO "- üîß Advanced Debugging Tools"
    BOLO "- ‚òÅÔ∏è Cloud Synchronization"
    BOLO "- üì± Multi-format Export Support"
    BOLO "- ‚ôø Full Accessibility Support"
    BOLO "- üåê PWA with Offline Functionality"
    
    BOLO "üé¨ Professional Bollywood Programming at its finest!"
ACTION</textarea>
                    <div id="editor-help" class="sr-only">
                        AmitabhC Pro editor with advanced syntax highlighting, autocomplete, and real-time error checking. 
                        Use Ctrl+Space for suggestions, F5 to run code, Ctrl+/ to toggle comments.
                    </div>
                </div>

                <!-- Output Section -->
                <section class="output-section" 
                         role="log" 
                         aria-label="Program Output">
                    <div class="resize-handle" 
                         id="resizeHandle"
                         aria-label="Resize output panel"
                         role="separator"
                         aria-orientation="horizontal"></div>
                    
                    <div class="output-header">
                        <h3 class="output-title">
                            <span aria-hidden="true">üì∫</span> Output Console
                            <span class="output-subtitle">Secure Execution Environment</span>
                        </h3>
                        <div class="output-controls" role="group" aria-label="Output controls">
                            <button class="btn-secondary" 
                                    onclick="clearOutput()" 
                                    aria-label="Clear console output"
                                    class="tooltip"
                                    data-tooltip="Clear output console">
                                <span aria-hidden="true">üóëÔ∏è</span>
                            </button>
                            <button class="btn-secondary" 
                                    onclick="downloadOutput()" 
                                    aria-label="Download output as text file"
                                    class="tooltip"
                                    data-tooltip="Download execution log">
                                <span aria-hidden="true">üíæ</span>
                            </button>
                            <button class="btn-secondary" 
                                    onclick="toggleFullscreen()" 
                                    aria-label="Toggle fullscreen output"
                                    class="tooltip"
                                    data-tooltip="Maximize output panel">
                                <span aria-hidden="true">‚õ∂</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="output-body" 
                         id="outputBody"
                         role="log"
                         aria-live="polite"
                         aria-label="Program execution output">
                        <div class="output-line info">
                            <span class="output-timestamp">[System]</span>
                            ‚ú® AmitabhC Pro IDE initialized successfully!
                        </div>
                        <div class="output-line info">
                            <span class="output-timestamp">[System]</span>
                            üé¨ "Jahan code shuru hota hai, wahin se programming ki line shuru hoti hai!"
                        </div>
                        <div class="output-line success">
                            <span class="output-timestamp">[Security]</span>
                            üõ°Ô∏è Secure execution environment active - no eval(), comprehensive sanitization
                        </div>
                        <div class="output-line kbc">
                            <span class="output-timestamp">[KBC]</span>
                            üéØ Interactive programming features enabled
                        </div>
                    </div>
                </section>
            </section>
        </main>

        <!-- Status Bar -->
        <footer class="status" role="contentinfo" aria-label="IDE Status">
            <div class="status-item ready">
                <span aria-hidden="true">‚óè</span>
                <span id="mainStatus">Ready</span>
            </div>
            <div class="status-item">
                <span id="cursorPosition">Line 1, Col 1</span>
            </div>
            <div class="status-item">
                <span id="fileEncoding">UTF-8</span>
            </div>
            <div class="status-item">
                <span>AmitabhC</span>
            </div>
            <div class="status-item">
                <span id="executionTime"></span>
            </div>
            <div style="margin-left: auto; display: flex; gap: 16px;">
                <span style="font-size: 11px; color: #7d8590;">Pro IDE v2.0.3</span>
                <span style="font-size: 11px; color: #7d8590;" id="memoryUsage">Memory: 0MB</span>
            </div>
        </footer>
    </div>

    <!-- AI Chat Dialog -->
    <dialog class="ai-chat" 
            id="aiChat"
            aria-labelledby="ai-chat-title"
            aria-describedby="ai-chat-desc">
        <div class="ai-chat-header">
            <h2 id="ai-chat-title" class="ai-chat-title">
                <span aria-hidden="true">ü§ñ</span> AmitabhC AI Assistant
                <span class="ai-status">‚óè Online</span>
            </h2>
            <button class="ai-chat-close" 
                    onclick="toggleAI()"
                    aria-label="Close AI Assistant">√ó</button>
        </div>
        
        <div id="ai-chat-desc" class="sr-only">
            AI assistant to help with AmitabhC programming questions, debugging, and best practices
        </div>
        
        <div class="ai-messages" 
             id="aiMessages"
             role="log"
             aria-live="polite"
             aria-label="AI conversation history">
            <!-- Messages will be added here dynamically -->
        </div>
        
        <div class="ai-suggestions" id="aiSuggestions">
            <h4>üí° Quick Suggestions:</h4>
            <div class="suggestion-chips">
                <button onclick="askAI('How do I use functions in AmitabhC?')" class="suggestion-chip">
                    Functions
                </button>
                <button onclick="askAI('Show me KBC programming examples')" class="suggestion-chip">
                    KBC Examples
                </button>
                <button onclick="askAI('How to debug my code?')" class="suggestion-chip">
                    Debugging
                </button>
                <button onclick="askAI('Security best practices')" class="suggestion-chip">
                    Security
                </button>
            </div>
        </div>
        
        <form onsubmit="sendAIMessage(); return false;" class="ai-input-area">
            <label for="aiInput" class="sr-only">Ask AI Assistant about AmitabhC programming</label>
            <input type="text" 
                   class="ai-input" 
                   id="aiInput"
                   placeholder="Ask me anything about AmitabhC..."
                   aria-describedby="ai-input-help"
                   maxlength="1000">
            <button type="submit" 
                    class="ai-send" 
                    aria-label="Send message to AI assistant">
                <span aria-hidden="true">üöÄ</span> Send
            </button>
            <div id="ai-input-help" class="sr-only">
                Type your question about AmitabhC programming and press Enter or click Send
            </div>
        </form>
    </dialog>

    <!-- Settings Dialog -->
    <dialog class="settings-dialog" id="settingsDialog" aria-labelledby="settings-title">
        <div class="settings-header">
            <h2 id="settings-title">‚öôÔ∏è IDE Settings</h2>
            <button class="settings-close" onclick="closeSettings()" aria-label="Close settings">√ó</button>
        </div>
        
        <div class="settings-content">
            <div class="settings-section">
                <h3>üé® Theme & Appearance</h3>
                <label>
                    <span>Editor Theme:</span>
                    <select id="themeSelect" onchange="changeTheme(this.value)">
                        <option value="dracula">Dracula (Dark)</option>
                        <option value="monokai">Monokai</option>
                        <option value="solarized">Solarized Light</option>
                        <option value="material">Material Dark</option>
                    </select>
                </label>
                <label>
                    <span>Font Size:</span>
                    <input type="range" id="fontSizeSlider" min="12" max="24" value="16" 
                           onchange="changeFontSize(this.value)">
                    <span id="fontSizeValue">16px</span>
                </label>
            </div>
            
            <div class="settings-section">
                <h3>üíª Editor Behavior</h3>
                <label>
                    <input type="checkbox" id="autoCompleteCheck" checked onchange="toggleAutoComplete(this.checked)">
                    <span>Enable Auto-completion</span>
                </label>
                <label>
                    <input type="checkbox" id="lineNumbersCheck" checked onchange="toggleLineNumbers(this.checked)">
                    <span>Show Line Numbers</span>
                </label>
                <label>
                    <input type="checkbox" id="wordWrapCheck" onchange="toggleWordWrap(this.checked)">
                    <span>Word Wrap</span>
                </label>
            </div>
            
            <div class="settings-section">
                <h3>üîß Advanced Options</h3>
                <label>
                    <input type="checkbox" id="autoSaveCheck" checked onchange="toggleAutoSave(this.checked)">
                    <span>Auto-save (every 30 seconds)</span>
                </label>
                <label>
                    <input type="checkbox" id="debugModeCheck" onchange="toggleDebugMode(this.checked)">
                    <span>Debug Mode</span>
                </label>
            </div>
        </div>
        
        <div class="settings-footer">
            <button onclick="resetSettings()" class="btn-secondary">Reset to Defaults</button>
            <button onclick="closeSettings()" class="btn-primary">Save & Close</button>
        </div>
    </dialog>

    <!-- Load dependencies -->
    <script src="interpreter.js"></script>
    
    <!-- Load CodeMirror with fallback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"
            onerror="loadFallbackScript('js/vendor/codemirror.min.js')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"
            onerror="loadFallbackScript('js/vendor/javascript.min.js')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"
            onerror="loadFallbackScript('js/vendor/show-hint.min.js')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"
            onerror="loadFallbackScript('js/vendor/matchbrackets.min.js')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"
            onerror="loadFallbackScript('js/vendor/closebrackets.min.js')"></script>

    <script>
        // Global state
        let editor;
        let interpreter;
        let currentFile = 'main.amitabhc';
        let isRunning = false;
        let autoSaveTimer;
        let settings = {
            theme: 'dracula',
            fontSize: 16,
            autoComplete: true,
            lineNumbers: true,
            wordWrap: false,
            autoSave: true,
            debugMode: false
        };

        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            if (typeof addOutput === 'function') {
                addOutput('‚ö†Ô∏è An unexpected error occurred. Please check the console.', 'error');
            }
        });

        // Promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            event.preventDefault();
        });

        // Fallback script loader
        function loadFallbackScript(src) {
            console.log('Loading fallback script:', src);
            const script = document.createElement('script');
            script.src = src;
            script.async = false;
            document.head.appendChild(script);
        }

        // Enhanced file contents with comprehensive examples
        const fileContents = {
            'main.amitabhc': document.getElementById('codeEditor').value,
            
            'examples.amitabhc': `LIGHTS
CAMERA
    // üé¨ AmitabhC Pro Examples Showcase
    BOLO "Professional AmitabhC Examples"
    BOLO "Showcasing enterprise-level Bollywood programming!"
    
    // üìä Advanced Mathematics with Error Handling
    NAAM safeDivision(dividend, divisor)
        AGAR divisor == 0
            BOLO "Error: Division by zero prevented!"
            WAPAS 0
        NAHI TOH
            WAPAS dividend / divisor
        BAS
    PURA
    
    VIJAY result = safeDivision(100, 5)
    BOLO "Safe division result: " + result
    
    // üéØ Advanced Conditional Logic
    VIJAY score = 85
    VIJAY grade = ""
    
    AGAR score >= 90
        VIJAY grade = "A+"
    NAHI TOH AGAR score >= 80
        VIJAY grade = "A"
    NAHI TOH AGAR score >= 70
        VIJAY grade = "B"
    NAHI TOH
        VIJAY grade = "C"
    BAS
    
    BOLO "Score: " + score + ", Grade: " + grade
    
    COMPUTER_JI_LOCK_KIYA_JAYE
    BOLO "Professional examples completed!"
ACTION`,

            'functions.amitabhc': `LIGHTS
CAMERA
    // ‚ö° Advanced Function Programming in AmitabhC
    BOLO "Professional Function Library"
    
    // üßÆ Mathematical Functions Suite
    NAAM factorial(n)
        AGAR n <= 1
            WAPAS 1
        NAHI TOH
            WAPAS n * factorial(n - 1)
        BAS
    PURA
    
    NAAM fibonacci(n)
        AGAR n <= 1
            WAPAS n
        NAHI TOH
            WAPAS fibonacci(n - 1) + fibonacci(n - 2)
        BAS
    PURA
    
    // Function Testing Suite
    BOLO "Testing Function Library:"
    
    VIJAY fact5 = factorial(5)
    BOLO "Factorial of 5: " + fact5
    
    VIJAY fib7 = fibonacci(7)
    BOLO "7th Fibonacci: " + fib7
    
    BOLO "Function library test completed!"
ACTION`,

            'calculator.amitabhc': `LIGHTS
CAMERA
    // üßÆ Professional Calculator - Enterprise Edition
    BOLO "AmitabhC Professional Calculator"
    BOLO "Advanced mathematical operations with error handling"
    
    // Basic Operations with Validation
    NAAM add(a, b)
        BOLO "Addition: " + a + " + " + b + " = " + (a + b)
        WAPAS a + b
    PURA
    
    NAAM safeDivide(a, b)
        AGAR b == 0
            BOLO "Error: Cannot divide by zero!"
            BOLO "Mathematical impossibility detected!"
            WAPAS 0
        NAHI TOH
            VIJAY result = a / b
            BOLO "Division: " + a + " / " + b + " = " + result
            WAPAS result
        BAS
    PURA
    
    // Calculator Test Suite
    BOLO "Running Calculator Tests:"
    
    VIJAY sum = add(150, 250)
    VIJAY quotient = safeDivide(144, 12)
    VIJAY zeroDiv = safeDivide(100, 0)
    
    BOLO "All basic operations tested"
    BOLO "Error handling verified"
    BOLO "Security measures active"
    
    COMPUTER_JI_LOCK_KIYA_JAYE
    BOLO "Professional calculator ready for use!"
ACTION`,

            'kbc_game.amitabhc': `LIGHTS
CAMERA
    // üèÜ Enhanced KBC Game - Professional Edition
    BOLO "KAUN BANEGA CROREPATI - PRO CODING EDITION"
    DEVIYON_AUR_SAJJANO
    BOLO "Main hoon aapka host, Amitabh Bachchan!"
    BOLO "Aaj ka show hai sabse advanced programming quiz!"
    
    // Advanced Game State Management
    VIJAY totalWinnings = 0
    VIJAY questionNumber = 1
    
    // Enhanced Prize Structure
    VIJAY prizeStructure[] = {1000, 5000, 10000, 50000, 100000}
    
    // Question Bank with Categories
    NAAM askQuestion(level, category)
        BOLO "Question " + level + " (" + category + ") for Rs. " + prizeStructure[level-1] + ":"
        
        AGAR level == 1
            BOLO "What command starts an AmitabhC program?"
            BOLO "A) START    B) BEGIN    C) LIGHTS    D) INIT"
            WAPAS "C"
        NAHI TOH AGAR level == 2
            BOLO "Which film-inspired command declares variables?"
            BOLO "A) HERO    B) VIJAY    C) ACTOR    D) STAR"
            WAPAS "B"
        NAHI TOH
            BOLO "Advanced: What does COMPUTER_JI_LOCK_KIYA_JAYE do?"
            BOLO "A) Exits    B) Loops    C) Confirms    D) Calculates"
            WAPAS "C"
        BAS
    PURA
    
    // Main Game Loop
    BOLO "GAME START!"
    
    // Question 1 - Basic Level
    VIJAY correctAnswer = askQuestion(1, "Basics")
    
    AUDIENCE_POLL
    BOLO "Audience wisdom received!"
    
    BOLO "Final Answer: C) LIGHTS"
    COMPUTER_JI_LOCK_KIYA_JAYE
    
    VIJAY totalWinnings = prizeStructure[0]
    BOLO "Congratulations! You've won Rs. " + totalWinnings + "!"
    
    BOLO "Thank you for playing KBC - Pro Coding Edition!"
    BOLO "Continue your programming journey with AmitabhC!"
ACTION`
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            try {
                // Show loading screen
                const loadingScreen = document.getElementById('loadingScreen');
                
                // Initialize secure interpreter
                if (typeof SecureAmitabhCInterpreter === 'undefined') {
                    throw new Error('Secure interpreter not loaded');
                }
                
                interpreter = new SecureAmitabhCInterpreter();
                interpreter.setOutputCallback(addOutput);
                interpreter.setInputCallback(securePrompt);

                // Wait for CodeMirror to load
                await waitForCodeMirror();
                
                // Initialize CodeMirror editor
                const textarea = document.getElementById('codeEditor');
                
                editor = CodeMirror.fromTextArea(textarea, {
                    mode: 'javascript',
                    theme: settings.theme,
                    lineNumbers: settings.lineNumbers,
                    lineWrapping: settings.wordWrap,
                    matchBrackets: true,
                    autoCloseBrackets: true,
                    indentUnit: 4,
                    tabSize: 4,
                    styleActiveLine: true,
                    viewportMargin: Infinity,
                    showHint: settings.autoComplete,
                    extraKeys: {
                        "F5": function() { runCode(); },
                        "Ctrl-Space": "autocomplete",
                        "Ctrl-S": function() { saveToCloud(); },
                        "Ctrl-/": "toggleComment",
                        "Ctrl-Enter": function() { runCode(); },
                        "Escape": function() { if (isRunning) interpreter.stop(); }
                    }
                });
                
                // Set editor size and refresh
                editor.setSize("100%", "100%");
                editor.refresh();
                
                // Setup event listeners
                setupEventListeners();
                
                // Initialize AI
                initializeAI();
                
                // Load settings
                loadSettings();
                
                // Load default file
                openFile('main.amitabhc');
                
                // Hide loading screen
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    
                    // Focus editor after loading
                    setTimeout(() => {
                        if (editor) editor.focus();
                    }, 500);
                }, 1500);
                
                addOutput('‚ú® AmitabhC Pro IDE loaded successfully!', 'success');
                addOutput('üé¨ "Lights, Camera, Code!" - Welcome to professional Bollywood programming!', 'info');
                updateStatus('Ready');
                
            } catch (error) {
                console.error('App initialization error:', error);
                if (typeof addOutput === 'function') {
                    addOutput('‚ùå IDE initialization failed. Please refresh the page.', 'error');
                }
                updateStatus('Initialization failed', 'error');
            }
        }

        // Wait for CodeMirror to load
        function waitForCodeMirror() {
            return new Promise((resolve) => {
                if (typeof CodeMirror !== 'undefined') {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (typeof CodeMirror !== 'undefined') {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                    
                    // Timeout after 10 seconds
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        console.error('CodeMirror failed to load');
                        resolve(); // Continue anyway
                    }, 10000);
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Update cursor position
            editor.on('cursorActivity', function() {
                try {
                    const cursor = editor.getCursor();
                    document.getElementById('cursorPosition').textContent = `Line ${cursor.line + 1}, Col ${cursor.ch + 1}`;
                } catch (error) {
                    console.error('Cursor position update error:', error);
                }
            });
            
            // Auto-save functionality
            if (settings.autoSave) {
                editor.on('change', function() {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(() => {
                        saveToCloud();
                    }, 30000); // Auto-save every 30 seconds
                });
            }
            
            // Resize handler for output panel
            setupResizeHandler();
        }

        // Setup resize handler for output panel
        function setupResizeHandler() {
            const resizeHandle = document.getElementById('resizeHandle');
            const workspace = document.querySelector('.workspace');
            const outputSection = document.querySelector('.output-section');
            
            if (!resizeHandle || !workspace || !outputSection) return;
            
            let isResizing = false;
            let startY = 0;
            let startHeight = 0;
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startY = e.clientY;
                startHeight = outputSection.offsetHeight;
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'ns-resize';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const deltaY = startY - e.clientY;
                const newHeight = Math.max(150, Math.min(600, startHeight + deltaY));
                outputSection.style.height = newHeight + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';
                }
            });
        }

        // Initialize AI Assistant
        function initializeAI() {
            const aiMessages = document.getElementById('aiMessages');
            if (aiMessages) {
                // Add welcome message
                addAIMessage('ai', 'üé¨ Welcome to AmitabhC Pro! I\'m your AI programming assistant. I can help you with AmitabhC syntax, debugging, best practices, and KBC-style interactive programming. What would you like to learn today?');
            }
        }

        // Secure prompt function
        async function securePrompt(message) {
            return new Promise((resolve) => {
                try {
                    const sanitizedMessage = String(message || 'Enter value:')
                        .replace(/<[^>]*>/g, '')
                        .slice(0, 200);
                    
                    const input = prompt(sanitizedMessage);
                    
                    if (input === null) {
                        resolve(null);
                        return;
                    }
                    
                    const sanitizedInput = String(input)
                        .slice(0, 1000)
                        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                        .replace(/javascript:/gi, '')
                        .replace(/data:/gi, '');
                    
                    resolve(sanitizedInput);
                } catch (error) {
                    console.error('Input error:', error);
                    resolve(null);
                }
            });
        }

        // Enhanced output function with security
        function addOutput(message, className = 'print') {
            try {
                const outputBody = document.getElementById('outputBody');
                if (!outputBody) return;
                
                const sanitizedMessage = String(message || '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;')
                    .slice(0, 10000);
                
                const timestamp = new Date().toLocaleTimeString();
                const outputLine = document.createElement('div');
                outputLine.className = `output-line ${className}`;
                outputLine.setAttribute('role', 'log');
                
                outputLine.innerHTML = `
                    <span class="output-timestamp">[${timestamp}]</span>
                    ${sanitizedMessage}
                `;
                
                outputBody.appendChild(outputLine);
                outputBody.scrollTop = outputBody.scrollHeight;
                
                // Limit output lines to prevent memory issues
                const lines = outputBody.querySelectorAll('.output-line');
                if (lines.length > 1000) {
                    lines[0].remove();
                }
                
            } catch (error) {
                console.error('Output error:', error);
            }
        }

        // Update status function
        function updateStatus(message, type = 'info') {
            try {
                const statusText = document.getElementById('statusText');
                const mainStatus = document.getElementById('mainStatus');
                const loadingSpinner = document.getElementById('loadingSpinner');
                
                if (statusText) statusText.textContent = message;
                if (mainStatus) mainStatus.textContent = message;
                
                if (loadingSpinner) {
                    loadingSpinner.style.display = type === 'running' ? 'inline-block' : 'none';
                }
                
                // Update status item class
                const statusItem = document.querySelector('.status-item.ready, .status-item.error, .status-item.running');
                if (statusItem) {
                    statusItem.className = `status-item ${type}`;
                }
                
            } catch (error) {
                console.error('Status update error:', error);
            }
        }

        // Enhanced run code function
        // Replace the security check section in the runCode() function with this:
        async function runCode() {
    if (isRunning) {
        if (interpreter) {
            interpreter.stop();
        }
        isRunning = false;
        updateStatus('Stopped by user', 'warning');
        document.getElementById('runButton').innerHTML = '<span aria-hidden="true">‚ñ∂Ô∏è</span> Run';
        return;
    }

    try {
        if (!editor || !interpreter) {
            throw new Error('Editor or interpreter not available');
        }
        
        const code = editor.getValue().trim();
        
        if (!code) {
            addOutput('üìù Please write some AmitabhC code first!', 'warning');
            updateStatus('No code to run', 'warning');
            return;
        }
        
        // Enhanced security check - only flag actual code injection attempts
        // Check for script tags and javascript: URLs outside of strings
        const codeWithoutStrings = code
            .replace(/"[^"]*"/g, '""')  // Remove double-quoted strings
            .replace(/'[^']*'/g, "''");  // Remove single-quoted strings
        
        if (codeWithoutStrings.includes('<script') || 
            codeWithoutStrings.includes('javascript:') || 
            codeWithoutStrings.match(/\beval\s*\(/)) {  // Only match eval followed by (
            addOutput('üö´ Security violation: Potentially dangerous code detected!', 'error');
            updateStatus('Security violation', 'error');
            return;
        }
        
        // Update UI for running state
        isRunning = true;
        document.getElementById('runButton').innerHTML = '<span class="loading"></span> Stop';
        updateStatus('Running...', 'running');
        
        clearOutput();
        addOutput('üé¨ Lights... Camera... Action!', 'info');
        addOutput('üöÄ Starting secure AmitabhC execution...', 'info');
        
        const startTime = performance.now();
        const result = await interpreter.run(code);
        const executionTime = performance.now() - startTime;
        
        if (result.success) {
            addOutput('‚úÖ Program executed successfully!', 'success');
            addOutput(`‚è±Ô∏è Execution time: ${result.executionTime}ms`, 'info');
            addOutput(`üß† Memory usage: ${result.memoryUsage.variables} vars, ${result.memoryUsage.arrays} arrays, ${result.memoryUsage.functions} functions`, 'info');
            addOutput('üé¨ "Keh diya, bas keh diya!" - Program completed!', 'success');
            updateStatus('Execution successful', 'success');
        } else {
            addOutput(`‚ùå Runtime Error: ${result.error}`, 'error');
            addOutput('üîß Check your AmitabhC syntax and try again!', 'warning');
            updateStatus('Execution failed', 'error');
        }
        
    } catch (error) {
        console.error('Execution error:', error);
        addOutput(`‚ùå Execution failed: ${error.message}`, 'error');
        updateStatus('Execution error', 'error');
    } finally {
        isRunning = false;
        const runButton = document.getElementById('runButton');
        if (runButton) {
            runButton.innerHTML = '<span aria-hidden="true">‚ñ∂Ô∏è</span> Run';
        }
        
        setTimeout(() => {
            updateStatus('Ready');
        }, 2000);
    }
}
        // File management functions
        function openFile(fileName) {
            try {
                if (!fileContents[fileName]) {
                    addOutput(`‚ùå File '${fileName}' not found`, 'error');
                    return;
                }
                
                currentFile = fileName;
                
                if (editor) {
                    editor.setValue(fileContents[fileName]);
                    editor.clearHistory();
                }
                
                // Update tab
                const tabName = document.getElementById('tabName');
                if (tabName) {
                    tabName.textContent = fileName;
                }
                
                // Update active file in explorer
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.textContent.includes(fileName)) {
                        item.classList.add('active');
                    }
                });
                
                addOutput(`üìÅ Opened file: ${fileName}`, 'info');
                updateStatus(`File: ${fileName}`);
                
                // Focus editor
                if (editor) {
                    editor.focus();
                }
                
            } catch (error) {
                console.error('File open error:', error);
                addOutput('‚ùå Failed to open file', 'error');
            }
        }

        function closeTab() {
            try {
                // For now, just clear the editor and load main file
                openFile('main.amitabhc');
            } catch (error) {
                console.error('Tab close error:', error);
            }
        }

        // AI Chat functions
        function toggleAI() {
            try {
                const aiChat = document.getElementById('aiChat');
                const aiToggle = document.getElementById('aiToggle');
                
                if (aiChat && aiToggle) {
                    const isActive = aiChat.classList.contains('active');
                    
                    if (isActive) {
                        aiChat.classList.remove('active');
                        aiChat.style.display = 'none';
                        aiToggle.setAttribute('aria-expanded', 'false');
                    } else {
                        aiChat.classList.add('active');
                        aiChat.style.display = 'grid';
                        aiToggle.setAttribute('aria-expanded', 'true');
                        
                        // Focus the input
                        const aiInput = document.getElementById('aiInput');
                        if (aiInput) {
                            setTimeout(() => aiInput.focus(), 100);
                        }
                    }
                }
            } catch (error) {
                console.error('AI toggle error:', error);
            }
        }

        function addAIMessage(sender, message) {
            try {
                const aiMessages = document.getElementById('aiMessages');
                if (!aiMessages) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `ai-message ${sender}`;
                
                const sanitizedMessage = String(message)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .slice(0, 5000);
                
                messageDiv.textContent = sanitizedMessage;
                aiMessages.appendChild(messageDiv);
                aiMessages.scrollTop = aiMessages.scrollHeight;
                
            } catch (error) {
                console.error('AI message error:', error);
            }
        }

        function sendAIMessage() {
            try {
                const aiInput = document.getElementById('aiInput');
                if (!aiInput) return;
                
                const message = aiInput.value.trim();
                if (!message) return;
                
                // Add user message
                addAIMessage('user', message);
                
                // Clear input
                aiInput.value = '';
                
                // Simulate AI response
                setTimeout(() => {
                    const responses = getAIResponse(message);
                    addAIMessage('ai', responses);
                }, 1000);
                
            } catch (error) {
                console.error('Send AI message error:', error);
            }
        }

        function askAI(question) {
            try {
                const aiInput = document.getElementById('aiInput');
                if (aiInput) {
                    aiInput.value = question;
                    sendAIMessage();
                }
            } catch (error) {
                console.error('Ask AI error:', error);
            }
        }

        function getAIResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('function') || lowerMessage.includes('naam')) {
                return `üéØ Functions in AmitabhC are defined using NAAM and ended with PURA:

Functions example:
NAAM functionName(param1, param2)
    // Function body
    BOLO "Hello from function!"
    WAPAS result
PURA

Key points:
‚Ä¢ Use NAAM to define functions
‚Ä¢ Parameters are optional
‚Ä¢ Use WAPAS to return values
‚Ä¢ End with PURA
‚Ä¢ Call functions by name: functionName(arg1, arg2)`;
            }
            
            if (lowerMessage.includes('kbc') || lowerMessage.includes('interactive')) {
                return `üé™ KBC Interactive Programming Commands:

‚Ä¢ DEVIYON_AUR_SAJJANO - Program greeting
‚Ä¢ COMPUTER_JI_LOCK_KIYA_JAYE - Lock/confirm answer
‚Ä¢ LIFELINE_FIFTY_FIFTY - Remove wrong options
‚Ä¢ AUDIENCE_POLL - Get majority opinion
‚Ä¢ PHONE_A_FRIEND "expert" - Call for help
‚Ä¢ EXPERT_ADVICE - Get professional advice

These make your programs interactive and fun! üé¨`;
            }
            
            if (lowerMessage.includes('debug') || lowerMessage.includes('error')) {
                return `üîß Debugging in AmitabhC:

Common issues:
‚Ä¢ Missing LIGHTS/CAMERA/ACTION structure
‚Ä¢ Incorrect variable syntax (use VIJAY)
‚Ä¢ Division by zero (use AGAR to check)
‚Ä¢ Missing BAS after AGAR blocks
‚Ä¢ Infinite loops (use BAAR BAAR with limits)

Security features help catch errors:
‚Ä¢ Automatic input sanitization
‚Ä¢ Execution timeouts
‚Ä¢ Memory limits
‚Ä¢ Type checking

Use BOLO statements to trace execution! üéØ`;
            }
            
            if (lowerMessage.includes('security') || lowerMessage.includes('safe')) {
                return `üõ°Ô∏è AmitabhC Security Features:

‚úÖ No eval() or Function() usage
‚úÖ Comprehensive input sanitization
‚úÖ XSS protection and filtering
‚úÖ Execution timeouts (30 seconds max)
‚úÖ Memory usage limits
‚úÖ Loop iteration limits (10,000 max)
‚úÖ Recursion depth limits (100 max)
‚úÖ Prototype pollution prevention

All code runs in a secure sandbox environment! üîí`;
            }
            
            // Default response
            return `üé¨ I'm here to help with AmitabhC programming! 

You can ask me about:
‚Ä¢ Syntax and commands
‚Ä¢ Function definitions
‚Ä¢ KBC interactive features
‚Ä¢ Debugging and troubleshooting
‚Ä¢ Security best practices
‚Ä¢ Performance optimization

What specific topic would you like to explore? Type your question and I'll provide detailed guidance! üöÄ`;
        }

        // Settings functions
        function openSettings() {
            try {
                const settingsDialog = document.getElementById('settingsDialog');
                if (settingsDialog) {
                    settingsDialog.classList.add('active');
                    settingsDialog.style.display = 'grid';
                    
                    // Load current settings
                    loadSettingsIntoDialog();
                }
            } catch (error) {
                console.error('Settings open error:', error);
            }
        }

        function closeSettings() {
            try {
                const settingsDialog = document.getElementById('settingsDialog');
                if (settingsDialog) {
                    settingsDialog.classList.remove('active');
                    settingsDialog.style.display = 'none';
                }
            } catch (error) {
                console.error('Settings close error:', error);
            }
        }

        function loadSettingsIntoDialog() {
            try {
                const themeSelect = document.getElementById('themeSelect');
                const fontSizeSlider = document.getElementById('fontSizeSlider');
                const fontSizeValue = document.getElementById('fontSizeValue');
                const autoCompleteCheck = document.getElementById('autoCompleteCheck');
                const lineNumbersCheck = document.getElementById('lineNumbersCheck');
                const wordWrapCheck = document.getElementById('wordWrapCheck');
                const autoSaveCheck = document.getElementById('autoSaveCheck');
                const debugModeCheck = document.getElementById('debugModeCheck');
                
                if (themeSelect) themeSelect.value = settings.theme;
                if (fontSizeSlider) {
                    fontSizeSlider.value = settings.fontSize;
                    if (fontSizeValue) fontSizeValue.textContent = settings.fontSize + 'px';
                }
                if (autoCompleteCheck) autoCompleteCheck.checked = settings.autoComplete;
                if (lineNumbersCheck) lineNumbersCheck.checked = settings.lineNumbers;
                if (wordWrapCheck) wordWrapCheck.checked = settings.wordWrap;
                if (autoSaveCheck) autoSaveCheck.checked = settings.autoSave;
                if (debugModeCheck) debugModeCheck.checked = settings.debugMode;
                
            } catch (error) {
                console.error('Load settings error:', error);
            }
        }

        // Settings change handlers
        function changeTheme(theme) {
            try {
                settings.theme = theme;
                if (editor) {
                    editor.setOption('theme', theme);
                }
                saveSettings();
            } catch (error) {
                console.error('Theme change error:', error);
            }
        }

        function changeFontSize(size) {
            try {
                settings.fontSize = parseInt(size);
                const fontSizeValue = document.getElementById('fontSizeValue');
                if (fontSizeValue) {
                    fontSizeValue.textContent = size + 'px';
                }
                
                if (editor) {
                    const editorElement = editor.getWrapperElement();
                    editorElement.style.fontSize = size + 'px';
                    editor.refresh();
                }
                
                saveSettings();
            } catch (error) {
                console.error('Font size change error:', error);
            }
        }

        function toggleAutoComplete(enabled) {
            try {
                settings.autoComplete = enabled;
                saveSettings();
            } catch (error) {
                console.error('Autocomplete toggle error:', error);
            }
        }

        function toggleLineNumbers(enabled) {
            try {
                settings.lineNumbers = enabled;
                if (editor) {
                    editor.setOption('lineNumbers', enabled);
                }
                saveSettings();
            } catch (error) {
                console.error('Line numbers toggle error:', error);
            }
        }

        function toggleWordWrap(enabled) {
            try {
                settings.wordWrap = enabled;
                if (editor) {
                    editor.setOption('lineWrapping', enabled);
                }
                saveSettings();
            } catch (error) {
                console.error('Word wrap toggle error:', error);
            }
        }

        function toggleAutoSave(enabled) {
            try {
                settings.autoSave = enabled;
                saveSettings();
            } catch (error) {
                console.error('Auto save toggle error:', error);
            }
        }

        function toggleDebugMode(enabled) {
            try {
                settings.debugMode = enabled;
                if (enabled) {
                    addOutput('üîß Debug mode enabled', 'info');
                } else {
                    addOutput('üîß Debug mode disabled', 'info');
                }
                saveSettings();
            } catch (error) {
                console.error('Debug mode toggle error:', error);
            }
        }

        function resetSettings() {
            try {
                settings = {
                    theme: 'dracula',
                    fontSize: 16,
                    autoComplete: true,
                    lineNumbers: true,
                    wordWrap: false,
                    autoSave: true,
                    debugMode: false
                };
                
                loadSettingsIntoDialog();
                applySettings();
                saveSettings();
                
                addOutput('‚öôÔ∏è Settings reset to defaults', 'info');
            } catch (error) {
                console.error('Reset settings error:', error);
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem('amitabhc_pro_settings', JSON.stringify(settings));
            } catch (error) {
                console.error('Save settings error:', error);
            }
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem('amitabhc_pro_settings');
                if (saved) {
                    settings = { ...settings, ...JSON.parse(saved) };
                    applySettings();
                }
            } catch (error) {
                console.error('Load settings error:', error);
            }
        }

        function applySettings() {
            try {
                if (editor) {
                    editor.setOption('theme', settings.theme);
                    editor.setOption('lineNumbers', settings.lineNumbers);
                    editor.setOption('lineWrapping', settings.wordWrap);
                    
                    const editorElement = editor.getWrapperElement();
                    editorElement.style.fontSize = settings.fontSize + 'px';
                    editor.refresh();
                }
            } catch (error) {
                console.error('Apply settings error:', error);
            }
        }

        // File operations
        function exportCode() {
            try {
                if (!editor) return;
                
                const code = editor.getValue();
                if (!code.trim()) {
                    addOutput('üìù No code to export!', 'warning');
                    return;
                }
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const filename = `${currentFile.replace('.amitabhc', '')}-${timestamp}.amitabhc`;
                
                const metadata = `// AmitabhC Pro Export
// File: ${currentFile}
// Exported: ${new Date().toLocaleString()}
// IDE Version: 2.0.3

`;
                
                const exportCode = metadata + code;
                
                const blob = new Blob([exportCode], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                addOutput(`üíæ Code exported as ${filename}`, 'success');
                updateStatus('Export successful', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                addOutput('‚ùå Export failed', 'error');
            }
        }

        function saveToCloud() {
            try {
                if (!editor) return;
                
                const code = editor.getValue();
                const key = `amitabhc_pro_${currentFile}`;
                
                localStorage.setItem(key, code);
                localStorage.setItem(`${key}_timestamp`, new Date().toISOString());
                
                addOutput(`‚òÅÔ∏è Saved ${currentFile} to local storage`, 'success');
                updateStatus('Auto-saved', 'success');
                
                setTimeout(() => {
                    updateStatus('Ready');
                }, 2000);
                
            } catch (error) {
                console.error('Save error:', error);
                addOutput('‚ùå Save failed', 'error');
            }
        }

        // Output management
        function clearOutput() {
            try {
                const outputBody = document.getElementById('outputBody');
                if (outputBody) {
                    outputBody.innerHTML = '';
                    addOutput('Console cleared - Ready for new output! üßπ', 'info');
                }
            } catch (error) {
                console.error('Clear output error:', error);
            }
        }

        function downloadOutput() {
            try {
                const outputBody = document.getElementById('outputBody');
                if (!outputBody) return;
                
                const lines = outputBody.querySelectorAll('.output-line');
                if (lines.length === 0) {
                    addOutput('üìù No output to download!', 'warning');
                    return;
                }
                
                let logContent = `AmitabhC Pro IDE - Execution Log
Generated: ${new Date().toLocaleString()}
File: ${currentFile}

`;
                
                lines.forEach(line => {
                    logContent += line.textContent + '\n';
                });
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const filename = `amitabhc-log-${timestamp}.txt`;
                
                const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                addOutput(`üíæ Log downloaded as ${filename}`, 'success');
                
            } catch (error) {
                console.error('Download output error:', error);
                addOutput('‚ùå Download failed', 'error');
            }
        }

        function toggleFullscreen() {
            try {
                const outputSection = document.querySelector('.output-section');
                if (!outputSection) return;
                
                if (outputSection.classList.contains('fullscreen')) {
                    outputSection.classList.remove('fullscreen');
                    outputSection.style.position = '';
                    outputSection.style.top = '';
                    outputSection.style.left = '';
                    outputSection.style.width = '';
                    outputSection.style.height = '';
                    outputSection.style.zIndex = '';
                } else {
                    outputSection.classList.add('fullscreen');
                    outputSection.style.position = 'fixed';
                    outputSection.style.top = '0';
                    outputSection.style.left = '0';
                    outputSection.style.width = '100vw';
                    outputSection.style.height = '100vh';
                    outputSection.style.zIndex = '1000';
                }
            } catch (error) {
                console.error('Fullscreen toggle error:', error);
            }
        }

        // Mobile sidebar toggle
        function toggleMobileSidebar() {
            try {
                const sidebar = document.querySelector('.sidebar');
                const mobileToggle = document.querySelector('.mobile-toggle');
                
                if (sidebar && mobileToggle) {
                    const isOpen = sidebar.classList.contains('mobile-open');
                    
                    if (isOpen) {
                        sidebar.classList.remove('mobile-open');
                        mobileToggle.setAttribute('aria-expanded', 'false');
                    } else {
                        sidebar.classList.add('mobile-open');
                        mobileToggle.setAttribute('aria-expanded', 'true');
                    }
                }
            } catch (error) {
                console.error('Mobile sidebar toggle error:', error);
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            try {
                // F5 - Run code
                if (e.key === 'F5') {
                    e.preventDefault();
                    runCode();
                }
                
                // Ctrl+S - Save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveToCloud();
                }
                
                // Ctrl+Shift+P - Settings
                if (e.ctrlKey && e.shiftKey && e.key === 'P') {
                    e.preventDefault();
                    openSettings();
                }
                
                // Escape - Close dialogs
                if (e.key === 'Escape') {
                    closeSettings();
                    const aiChat = document.getElementById('aiChat');
                    if (aiChat && aiChat.classList.contains('active')) {
                        toggleAI();
                    }
                }
                
                // Enhanced tab navigation
                if (e.key === 'Tab') {
                    document.body.classList.add('using-keyboard');
                }
                
            } catch (error) {
                console.error('Keyboard shortcut error:', error);
            }
        });

        // Remove keyboard class on mouse use
        document.addEventListener('mousedown', function() {
            document.body.classList.remove('using-keyboard');
        });

        // Performance monitoring
        window.addEventListener('load', function() {
            if (typeof performance !== 'undefined' && performance.mark) {
                performance.mark('amitabhc-pro-loaded');
            }
            console.log('üé¨ AmitabhC Pro IDE loaded successfully!');
        });

        console.log('AmitabhC Pro IDE JavaScript loaded! üé¨‚ú®');
    </script>
</body>
</html>