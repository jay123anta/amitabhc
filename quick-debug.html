<!DOCTYPE html>
<html>
<head>
    <title>Test String Concatenation Fix</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        #output { background: #000; padding: 15px; border-radius: 5px; margin: 20px 0; }
        button { background: #ff9933; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .success { color: #4ade80; }
        .error { color: #ef4444; }
        .debug { color: #3b82f6; }
    </style>
</head>
<body>
    <h2>🔧 Test String Concatenation Fix</h2>
    <button onclick="testConcatenation()">Test Concatenation</button>
    <div id="output"></div>

    <script src="interpreter.js"></script>

    <script>
        function addOutput(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            output.appendChild(div);
        }

        function testConcatenation() {
            document.getElementById('output').innerHTML = '';
            
            if (typeof SecureAmitabhCInterpreter === 'undefined') {
                addOutput('❌ SecureAmitabhCInterpreter not found!', 'error');
                return;
            }

            const interpreter = new SecureAmitabhCInterpreter();
            interpreter.setOutputCallback((msg) => addOutput(`OUTPUT: ${msg}`, 'success'));

            // Add debugging to applyOperation
            if (interpreter.applyOperation) {
                const originalApplyOperation = interpreter.applyOperation.bind(interpreter);
                interpreter.applyOperation = function(left, right, operator) {
                    addOutput(`🔧 applyOperation called: ${JSON.stringify(left)} ${operator} ${JSON.stringify(right)}`, 'debug');
                    addOutput(`🔧 Left type: ${typeof left}, Right type: ${typeof right}`, 'debug');
                    
                    try {
                        const result = originalApplyOperation.call(this, left, right, operator);
                        addOutput(`✅ applyOperation result: ${JSON.stringify(result)} (type: ${typeof result})`, 'debug');
                        return result;
                    } catch (error) {
                        addOutput(`❌ applyOperation error: ${error.message}`, 'error');
                        throw error;
                    }
                };
            }

            // Add debugging to sanitizeOperand
            if (interpreter.sanitizeOperand) {
                const originalSanitizeOperand = interpreter.sanitizeOperand.bind(interpreter);
                interpreter.sanitizeOperand = function(operand) {
                    addOutput(`🧹 sanitizeOperand called with: ${JSON.stringify(operand)} (type: ${typeof operand})`, 'debug');
                    
                    try {
                        const result = originalSanitizeOperand.call(this, operand);
                        addOutput(`✅ sanitizeOperand result: ${JSON.stringify(result)} (type: ${typeof result})`, 'debug');
                        return result;
                    } catch (error) {
                        addOutput(`❌ sanitizeOperand error: ${error.message}`, 'error');
                        throw error;
                    }
                };
            }

            // Test concatenation scenarios
            const tests = [
                {
                    name: 'Simple string + number',
                    code: `LIGHTS
CAMERA
    BOLO "Result: " + 4
ACTION`
                },
                {
                    name: 'String + SHABD function',
                    code: `LIGHTS
CAMERA
    BOLO "Length: " + SHABD.length("test")
ACTION`
                },
                {
                    name: 'Multiple concatenations',
                    code: `LIGHTS
CAMERA
    BOLO "Length of 'hello' is " + SHABD.length("hello") + " characters"
ACTION`
                }
            ];

            let currentTest = 0;

            function runNextTest() {
                if (currentTest >= tests.length) {
                    addOutput('<h3>🎯 All tests completed!</h3>');
                    return;
                }

                const test = tests[currentTest];
                addOutput(`<h3>🧪 Test ${currentTest + 1}: ${test.name}</h3>`);

                interpreter.run(test.code).then(result => {
                    addOutput(`✅ Test ${currentTest + 1} result: Success = ${result.success}`);
                    if (!result.success) {
                        addOutput(`❌ Error: ${result.error}`, 'error');
                    }
                    addOutput('<hr>');
                    
                    currentTest++;
                    setTimeout(runNextTest, 100);
                }).catch(error => {
                    addOutput(`❌ Test ${currentTest + 1} crashed: ${error.message}`, 'error');
                    addOutput('<hr>');
                    
                    currentTest++;
                    setTimeout(runNextTest, 100);
                });
            }

            runNextTest();
        }
    </script>
</body>
</html>