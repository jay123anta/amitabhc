<!DOCTYPE html>
<html>
<head>
    <title>SHABD Diagnostic Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        #output { background: #000; padding: 15px; border-radius: 5px; margin: 20px 0; }
        button { background: #ff9933; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .success { color: #4ade80; }
        .error { color: #ef4444; }
        .debug { color: #3b82f6; }
    </style>
</head>
<body>
    <h2>üîç SHABD Diagnostic Test</h2>
    <button onclick="runDiagnostic()">Run Diagnostic</button>
    <div id="output"></div>

    <script src="interpreter.js"></script>

    <script>
        function addOutput(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            output.appendChild(div);
        }

        function runDiagnostic() {
            document.getElementById('output').innerHTML = '';
            
            if (typeof SecureAmitabhCInterpreter === 'undefined') {
                addOutput('‚ùå SecureAmitabhCInterpreter not found!', 'error');
                return;
            }

            const interpreter = new SecureAmitabhCInterpreter();
            interpreter.setOutputCallback((msg) => addOutput(`OUTPUT: ${msg}`, 'success'));

            // Add detailed debugging to see what's happening
            const originalParseExpression = interpreter.parseExpression.bind(interpreter);
            interpreter.parseExpression = function(expr) {
                addOutput(`üîç parseExpression called with: "${expr}"`, 'debug');
                
                try {
                    const result = originalParseExpression.call(this, expr);
                    addOutput(`‚úÖ parseExpression result: ${JSON.stringify(result)} (type: ${typeof result})`, 'debug');
                    return result;
                } catch (error) {
                    addOutput(`‚ùå parseExpression error: ${error.message}`, 'error');
                    throw error;
                }
            };

            // Add debugging to evaluateBuiltInFunction
            if (interpreter.evaluateBuiltInFunction) {
                const originalEvaluateBuiltInFunction = interpreter.evaluateBuiltInFunction.bind(interpreter);
                interpreter.evaluateBuiltInFunction = function(expr) {
                    addOutput(`üîß evaluateBuiltInFunction called with: "${expr}"`, 'debug');
                    
                    try {
                        const result = originalEvaluateBuiltInFunction.call(this, expr);
                        addOutput(`‚úÖ evaluateBuiltInFunction result: ${JSON.stringify(result)} (type: ${typeof result})`, 'debug');
                        return result;
                    } catch (error) {
                        addOutput(`‚ùå evaluateBuiltInFunction error: ${error.message}`, 'error');
                        throw error;
                    }
                };
            }

            // Add debugging to evaluateStringFunction
            if (interpreter.evaluateStringFunction) {
                const originalEvaluateStringFunction = interpreter.evaluateStringFunction.bind(interpreter);
                interpreter.evaluateStringFunction = function(functionName, args) {
                    addOutput(`üìù evaluateStringFunction called: ${functionName} with args: ${JSON.stringify(args)}`, 'debug');
                    
                    try {
                        const result = originalEvaluateStringFunction.call(this, functionName, args);
                        addOutput(`‚úÖ evaluateStringFunction result: ${JSON.stringify(result)} (type: ${typeof result})`, 'debug');
                        return result;
                    } catch (error) {
                        addOutput(`‚ùå evaluateStringFunction error: ${error.message}`, 'error');
                        throw error;
                    }
                };
            }

            // Test simple SHABD function first
            addOutput('<h3>üß™ Testing Simple SHABD Function</h3>');
            
            const simpleTest = `LIGHTS
CAMERA
    BOLO SHABD.length("test")
ACTION`;

            interpreter.run(simpleTest).then(result => {
                addOutput(`<h3>üìä Simple Test Result:</h3>`);
                addOutput(`Success: ${result.success}`);
                if (!result.success) {
                    addOutput(`Error: ${result.error}`, 'error');
                }
                
                // Now test with concatenation
                addOutput('<h3>üß™ Testing SHABD with String Concatenation</h3>');
                
                const concatTest = `LIGHTS
CAMERA
    BOLO "Result: " + SHABD.length("test")
ACTION`;

                return interpreter.run(concatTest);
            }).then(result => {
                addOutput(`<h3>üìä Concatenation Test Result:</h3>`);
                addOutput(`Success: ${result.success}`);
                if (!result.success) {
                    addOutput(`Error: ${result.error}`, 'error');
                }
                
                addOutput('<h3>üéØ Diagnostic Complete</h3>');
            }).catch(error => {
                addOutput(`‚ùå Test crashed: ${error.message}`, 'error');
            });
        }
    </script>
</body>
</html>