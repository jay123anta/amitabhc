<!DOCTYPE html>
<html>
<head>
    <title>Debug BOLO Execution</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        #output { background: #000; padding: 15px; border-radius: 5px; margin: 20px 0; }
        button { background: #ff9933; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .debug { color: #3b82f6; }
        .error { color: #ef4444; }
        .critical { color: #ff3333; font-weight: bold; }
    </style>
</head>
<body>
    <h2>🔍 Debug BOLO Execution</h2>
    <button onclick="debugBOLO()">Debug BOLO</button>
    <div id="output"></div>

    <script src="interpreter.js"></script>

    <script>
        function addOutput(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            output.appendChild(div);
        }

        function debugBOLO() {
            document.getElementById('output').innerHTML = '';
            
            if (typeof SecureAmitabhCInterpreter === 'undefined') {
                addOutput('❌ SecureAmitabhCInterpreter not found!', 'error');
                return;
            }

            const interpreter = new SecureAmitabhCInterpreter();
            interpreter.setOutputCallback((msg) => addOutput(`OUTPUT: ${msg}`, 'info'));

            // Add detailed debugging to executeBolo
            if (interpreter.executeBolo) {
                const originalExecuteBolo = interpreter.executeBolo.bind(interpreter);
                interpreter.executeBolo = function(line) {
                    addOutput(`🔍 executeBolo called with: "${line}"`, 'debug');
                    
                    try {
                        const result = originalExecuteBolo.call(this, line);
                        addOutput(`✅ executeBolo completed`, 'debug');
                        return result;
                    } catch (error) {
                        addOutput(`❌ executeBolo error: ${error.message}`, 'error');
                        throw error;
                    }
                };
            }

            // Add debugging to parseExpression
            const originalParseExpression = interpreter.parseExpression.bind(interpreter);
            interpreter.parseExpression = function(expr) {
                addOutput(`🧮 parseExpression: "${expr}"`, 'debug');
                
                try {
                    const result = originalParseExpression.call(this, expr);
                    addOutput(`✅ parseExpression result: ${JSON.stringify(result)} (${typeof result})`, 'debug');
                    return result;
                } catch (error) {
                    addOutput(`❌ parseExpression error: ${error.message}`, 'error');
                    throw error;
                }
            };

            // Test simple cases step by step
            const tests = [
                {
                    name: 'Simple string',
                    code: 'LIGHTS\nCAMERA\n    BOLO "Hello"\nACTION'
                },
                {
                    name: 'Simple number',
                    code: 'LIGHTS\nCAMERA\n    BOLO 42\nACTION'
                },
                {
                    name: 'Simple concatenation',
                    code: 'LIGHTS\nCAMERA\n    BOLO "Result: " + 4\nACTION'
                },
                {
                    name: 'SHABD function alone',
                    code: 'LIGHTS\nCAMERA\n    BOLO SHABD.length("test")\nACTION'
                },
                {
                    name: 'SHABD with concatenation',
                    code: 'LIGHTS\nCAMERA\n    BOLO "Length: " + SHABD.length("test")\nACTION'
                }
            ];

            let currentTest = 0;

            function runNextTest() {
                if (currentTest >= tests.length) {
                    addOutput('<h3>🎯 All tests completed!</h3>');
                    return;
                }

                const test = tests[currentTest];
                addOutput(`<h3>🧪 Test ${currentTest + 1}: ${test.name}</h3>`);

                interpreter.run(test.code).then(result => {
                    addOutput(`📊 Test result: Success = ${result.success}`);
                    if (!result.success) {
                        addOutput(`❌ Error: ${result.error}`, 'error');
                    }
                    addOutput('<hr>');
                    
                    currentTest++;
                    setTimeout(runNextTest, 500);
                }).catch(error => {
                    addOutput(`❌ Test crashed: ${error.message}`, 'error');
                    addOutput('<hr>');
                    
                    currentTest++;
                    setTimeout(runNextTest, 500);
                });
            }

            runNextTest();
        }
    </script>
</body>
</html>